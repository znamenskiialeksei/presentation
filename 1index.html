<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vasilisapresentation.</title>
    <script src='https://meet.jit.si/external_api.js'></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/lint.min.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/theme/material-darker.min.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/foldgutter.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/lint/json-lint.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsonlint@1.6.3/lib/jsonlint.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.15/addon/fold/brace-fold.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify.min.js"></script>

    <style>
        /* Начало блока для встраивания CSS-стилей прямо в HTML-документ */
        /* --- ОБЩИЕ СТИЛИ ДЛЯ BODY И ОСНОВНЫХ КОНТЕЙНЕРОВ --- */
        body {
            /* Стили для всего тела документа */
            margin: 0;
            /* Убирает стандартные отступы по краям страницы */
            overflow: hidden;
            /* Скрывает полосы прокрутки, чтобы контент не выходил за пределы экрана (в режиме "книги") */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            /* Набор современных системных шрифтов для кросс-платформенной совместимости */
            display: flex;
            /* Включает Flexbox-модель для дочерних элементов, позволяя им гибко располагаться */
            flex-direction: column;
            /* Располагает дочерние элементы в колонку (вертикально) */
            height: 100vh;
            /* Устанавливает высоту тела равной 100% высоты видимой области окна (viewport height) */
            height: 100svh;
            /* Более новый стандарт (small viewport height), который лучше работает на мобильных устройствах, учитывая панели браузера */
        }

        .content-view {
            /* Общий класс для основных "экранов" приложения (обложка, страницы) */
            flex-grow: 1;
            /* Позволяет элементу занимать всё доступное свободное пространство внутри flex-контейнера (body) */
            position: relative;
            /* Устанавливает относительное позиционирование, чтобы дочерние абсолютные элементы позиционировались относительно него */
            display: none;
            /* Изначально все экраны скрыты */
            background-color: #000;
            /* Черный фон по умолчанию, виден при загрузке видео */
        }

        #cover-view.content-view {
            /* Стиль для контейнера обложки, когда он активен */
            display: flex;
            /* Делает контейнер обложки видимым, используя flex для центрирования дочерних элементов */
        }

        /* --- СТИЛИ ДЛЯ ОБЛОЖКИ (ВИДЕО, ТЕКСТ, КНОПКИ) --- */
        #cover-video {
            /* Стили для фонового видео на обложке */
            position: absolute;
            /* Абсолютное позиционирование относительно родительского .content-view */
            top: 0;
            /* Прижимает видео к верхнему краю */
            left: 0;
            /* Прижимает видео к левому краю */
            width: 100%;
            /* Растягивает видео на всю ширину родителя */
            height: 100%;
            /* Растягивает видео на всю высоту родителя */
            z-index: 1;
            /* Располагает видео на первом слое (под текстом и кнопками) */
            object-fit: cover;
            /* Масштабирует видео так, чтобы оно полностью покрывало контейнер, обрезая лишнее */
        }

        .cover-text-box {
            /* Контейнер для текста на обложке */
            position: absolute;
            /* Абсолютное позиционирование для размещения в любой точке экрана */
            z-index: 2;
            /* Размещается над видео (z-index: 1) */
            text-shadow: 2px 2px 5px rgba(8, 0, 0, 0.8);
            /* Тень для текста, улучшает читаемость на видео-фоне */
            font-size: 1.1em;
            /* Немного увеличенный размер шрифта */
            max-width: 90%;
            /* Ограничивает максимальную ширину, чтобы текст не прилипал к краям экрана */
            text-align: center;
            /* Центрирует текст внутри блока */
            transform: translate(-50%, -50%);
            /* Смещает блок на 50% его ширины и высоты, чтобы точно центрировать его по координатам top/left */
            display: flex;
            /* Включает flex для дочерних элементов */
            align-items: center;
            /* Выравнивает дочерние элементы по центру вертикально */
            justify-content: center;
            /* Выравнивает дочерние элементы по центру горизонтально */
            gap: 10px;
            /* Добавляет отступ между дочерними элементами */
            transition: opacity 0.5s;
            /* Плавный переход для свойства прозрачности */
        }

        .cover-text-bg {
            /* Стиль для подложки под текстом на обложке */
            background-color: rgba(0, 0, 0, 0.5);
            /* Полупрозрачный черный фон */
            padding: 5px 10px;
            /* Внутренние отступы для текста */
            color: rgb(246, 238, 238);
            /* Светлый цвет текста */
            white-space: nowrap;
            /* Запрещает перенос текста на новую строку */
        }

        #tooltip-box {
            /* Стили для всплывающей подсказки */
            position: fixed;
            /* Фиксированное позиционирование, остается на месте при прокрутке */
            z-index: 10001;
            /* Очень высокий z-index, чтобы быть поверх всех элементов */
            background-color: rgba(0, 0, 0, 0.8);
            /* Полупрозрачный черный фон */
            color: white;
            /* Белый цвет текста */
            padding: 8px 12px;
            /* Внутренние отступы */
            border-radius: 8px;
            /* Скругленные углы */
            font-size: 0.9em;
            /* Немного уменьшенный размер шрифта */
            max-width: 250px;
            /* Максимальная ширина подсказки */
            text-align: center;
            /* Центрирование текста */
            opacity: 0;
            /* Изначально полностью прозрачна */
            visibility: hidden;
            /* Изначально скрыта и неактивна */
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            /* Плавные переходы для появления/исчезновения */
            pointer-events: none;
            /* Подсказка не перехватывает клики мыши */
        }

        #tooltip-box.visible {
            /* Класс для видимой подсказки */
            opacity: 1;
            /* Делает подсказку непрозрачной */
            visibility: visible;
            /* Делает подсказку видимой и активной */
        }

        .cover-button {
            /* Общий стиль для круглых кнопок на обложке */
            position: absolute;
            /* Абсолютное позиционирование */
            z-index: 3;
            /* Поверх видео и текста */
            width: 50px;
            /* Ширина кнопки */
            height: 50px;
            /* Высота кнопки */
            border-radius: 50%;
            /* Делает кнопку идеально круглой */
            display: flex;
            /* Включает flex для центрирования иконки внутри */
            align-items: center;
            /* Центрирование по вертикали */
            justify-content: center;
            /* Центрирование по горизонтали */
            background-color: rgba(0, 0, 0, 0.5);
            /* Полупрозрачный фон */
            border: 2px solid white;
            /* Белая рамка */
            cursor: pointer;
            /* Указывает, что элемент кликабельный */
            transition: transform 0.2s, background-color 0.2s;
            /* Плавные переходы для эффектов при наведении */
            transform: translate(-50%, -50%);
            /* Центрирование кнопки относительно координат top/left */
        }

        .cover-button:hover {
            /* Эффект при наведении на кнопку */
            transform: translate(-50%, -50%) scale(1.1);
            /* Немного увеличивает кнопку */
            background-color: rgba(0, 0, 0, 0.7);
            /* Делает фон темнее */
        }

        .cover-button.route-selector-btn {
            /* Стиль для кнопки выбора маршрутов (прямоугольная) */
            width: 90px;
            /* Устанавливает ширину */
            height: 40px;
            /* Устанавливает высоту */
            border-radius: 8px;
            /* Делает углы скругленными, а не круглыми */
        }

        .cover-button svg {
            /* Стили для SVG иконок внутри кнопок */
            width: 28px;
            /* Ширина иконки */
            height: 28px;
            /* Высота иконки */
            fill: white;
            /* Цвет заливки иконки - белый */
        }

        /* --- АНИМАЦИЯ ПУЛЬСАЦИИ --- */
        .pulsing {
            /* Класс для добавления эффекта пульсации */
            animation-name: pulseAnimation;
            /* Название анимации, определенной ниже */
            animation-iteration-count: infinite;
            /* Зацикливает анимацию бесконечно */
            animation-timing-function: ease-in-out;
            /* Плавное начало и конец анимации */
            animation-duration: var(--pulse-total-duration, 8s);
            /* Длительность одного цикла анимации (берется из JS переменной или 8с по умолчанию) */
        }

        .cover-button.route-selector-btn svg {
            /* Специфичный стиль для SVG внутри кнопки маршрутов */
            width: 100%;
            /* SVG занимает всю ширину кнопки */
            height: 100%;
            /* SVG занимает всю высоту кнопки */
            fill: initial;
            /* Сбрасывает цвет заливки, чтобы использовались цвета из самого SVG кода */
        }

        @keyframes pulseAnimation {

            /* Определение самой анимации пульсации */
            0% {
                /* В начале анимации (0% времени) */
                opacity: 0;
                /* Элемент полностью прозрачен */
            }

            6.25% {
                /* Через 6.25% времени */
                opacity: 1;
                /* Элемент становится полностью видимым (плавное появление) */
            }

            56.25% {
                /* До 56.25% времени */
                opacity: 1;
                /* Элемент остается видимым */
            }

            81.25% {
                /* К 81.25% времени */
                opacity: 0;
                /* Элемент плавно исчезает */
            }

            100% {
                /* В конце анимации */
                opacity: 0;
                /* Элемент остается прозрачным до начала нового цикла */
            }
        }

        /* --- ВЫПАДАЮЩЕЕ МЕНЮ --- */
        .route-dropdown-menu {
            /* Стили для контейнера выпадающего меню */
            position: fixed;
            /* Фиксированное позиционирование */
            z-index: 10000;
            /* Поверх почти всех элементов */
            background-color: white;
            /* Белый фон */
            border-radius: 8px;
            /* Скругленные углы */
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            /* Тень для эффекта объема */
            padding: 8px;
            /* Внутренние отступы */
            min-width: 200px;
            /* Минимальная ширина меню */
            opacity: 0;
            /* Изначально прозрачно */
            visibility: hidden;
            /* Изначально скрыто */
            transition: opacity 0.2s, transform 0.2s, visibility 0.2s;
            /* Плавные переходы для появления */
        }

        .route-dropdown-menu.visible {
            /* Класс для видимого меню */
            opacity: 1;
            /* Делает видимым */
            visibility: visible;
            /* Делает активным */
        }

        .route-dropdown-menu a {
            /* Стили для ссылок внутри меню */
            display: block;
            /* Занимает всю ширину родителя */
            padding: 10px 15px;
            /* Внутренние отступы */
            color: #333;
            /* Темный цвет текста */
            text-decoration: none;
            /* Убирает подчеркивание у ссылок */
            border-radius: 6px;
            /* Небольшое скругление углов */
            transition: background-color 0.2s;
            /* Плавный переход цвета фона при наведении */
            cursor: pointer;
            /* Курсор в виде руки */
        }

        .route-dropdown-menu a:hover {
            /* Эффект при наведении на ссылку в меню */
            background-color: #f0f0f0;
            /* Светло-серый фон */
        }

        /* --- СТИЛИ ДЛЯ СТРАНИЦ КОНТЕНТА ("КНИГИ") --- */
        .page {
            /* Основной контейнер для одной страницы */
            position: relative;
            /* Страницы располагаются относительно .page-viewer */
            width: 100%;
            /* На всю ширину родителя */
            height: 100%;
            /* На всю высоту родителя */
            display: flex;
            /* Включает flexbox */
            flex-direction: column;
            /* Элементы внутри располагаются в колонку */
            align-items: center;
            /* Центрирует контент по горизонтали */
            padding: 20px;
            /* Внутренние отступы со всех сторон */
            box-sizing: border-box;
            /* padding не увеличивает общую ширину/высоту блока */
            opacity: 0;
            /* Изначально страница прозрачна */
            visibility: hidden;
            /* Изначально скрыта */
            transition: opacity 0.5s ease-in-out, height 0.3s ease-in-out;
            /* Плавный переход при смене страниц */
            background: white;
            /* Белый фон страницы */
        }

        .page.active {
            /* Класс для активной (видимой) страницы */
            opacity: 1;
            /* Делает страницу видимой */
            visibility: visible;
            /* Делает активной */
        }

        .page p {
            /* Стили для параграфов текста на странице */
            margin-top: 15px;
            /* Отступ сверху */
            text-align: left;
            /* Выравнивание текста по левому краю */
            font-size: 1.1em;
            /* Размер шрифта */
            line-height: 1.6;
            /* Межстрочный интервал */
            color: #333;
            /* Темно-серый цвет текста */
            overflow-y: auto;
            /* Добавляет вертикальную прокрутку, если текст не помещается */
            width: 100%;
            /* На всю ширину родителя */
            padding-right: 10px;
            /* Отступ справа для полосы прокрутки */
            flex-grow: 1;
            /* Занимает все доступное вертикальное пространство */
            min-height: 0;
            /* Необходимо для корректной работы flex-grow в некоторых браузерах */
            box-sizing: border-box;
            /* padding не увеличивает ширину */
        }

        .page-buttons-container {
            /* Контейнер для кнопок (Фото, Видео и т.д.) на странице */
            display: flex;
            /* Включает flexbox */
            flex-wrap: wrap;
            /* Позволяет кнопкам переноситься на новую строку, если они не помещаются */
            justify-content: center;
            /* Центрирует кнопки по горизонтали */
            gap: 10px;
            /* Расстояние между кнопками */
            margin-bottom: 15px;
            /* Отступ снизу */
            flex-shrink: 0;
            /* Запрещает контейнеру сжиматься, если не хватает места */
        }

        .page-btn {
            /* Общий стиль для кнопок на странице */
            color: white;
            /* Белый цвет текста */
            border: none;
            /* Убирает рамку */
            border-radius: 8px;
            /* Скругленные углы */
            padding: 10px 20px;
            /* Внутренние отступы */
            font-size: 1em;
            /* Размер шрифта */
            cursor: pointer;
            /* Курсор-рука */
            transition: background-color 0.3s;
            /* Плавный переход цвета фона */
        }

        .page-btn.video-btn,
        /* Стили для кнопок "видео" и "iframe" */
        .page-btn.iframe-btn {
            background-color: #4285F4;
            /* Синий цвет */
        }

        .page-btn.audio-btn {
            /* Стиль для кнопки "аудио" */
            background-color: #f4b400;
            /* Желтый цвет */
        }

        .page-btn.photo-btn {
            /* Стиль для кнопки "фото" */
            background-color: #0F9D58;
            /* Зеленый цвет */
        }

        .page-btn.text-btn {
            /* Стиль для кнопки "текст" */
            background-color: #673ab7;
            /* Фиолетовый цвет */
        }

        .page-btn.carousel-btn {
            /* Стиль для кнопки "карусель" */
            background-color: #9c27b0;
            /* Пурпурный цвет */
        }

        .page-btn:hover {
            /* Эффект при наведении на кнопки */
            filter: brightness(90%);
            /* Немного затемняет кнопку */
        }

        .page-btn.admin-error-btn {
            /* Стиль для кнопки, у которой ошибка в конфигурации (в админ-режиме) */
            background-color: #db4437;
            /* Красный цвет */
            cursor: not-allowed;
            /* Запрещающий курсор */
            border: 2px dashed white;
            /* Пунктирная рамка */
            font-weight: bold;
            /* Жирный шрифт */
        }

        .link-btn {
            /* Стили для отдельной кнопки-ссылки (не используется в текущей конфигурации, но присутствует в стилях) */
            position: absolute;
            /* Абсолютное позиционирование */
            z-index: 5;
            /* Поверх другого контента страницы */
            padding: 12px 24px;
            /* Внутренние отступы */
            font-size: 1em;
            /* Размер шрифта */
            font-weight: 600;
            /* Полужирное начертание */
            color: white;
            /* Белый текст */
            background: linear-gradient(45deg, #6a11cb 0%, #2575fc 100%);
            /* Градиентный фон */
            border: none;
            /* Без рамки */
            border-radius: 8px;
            /* Скругленные углы */
            left: 50%;
            /* Центрирование по горизонтали */
            top: 85%;
            /* Расположение в нижней части */
            transform: translate(-50%, -50%);
            /* Точное центрирование */
        }

        .link-btn:hover {
            /* Эффект при наведении */
            transform: translate(-50%, -50%) scale(1.05);
            /* Увеличение */
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            /* Тень */
        }

        /* --- СТИЛИ ДЛЯ МОДАЛЬНЫХ ОКОН --- */
        .modal {
            /* Общий стиль для фона модального окна */
            display: none;
            /* Изначально скрыт */
            position: fixed;
            /* Фиксированное позиционирование на весь экран */
            z-index: 1000;
            /* Высокий z-index, но ниже чем у подсказок */
            left: 0;
            /* На всю ширину */
            top: 0;
            /* На всю высоту */
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            /* Полупрозрачный черный фон */
            justify-content: center;
            /* Центрирование контента по горизонтали */
            align-items: center;
            /* Центрирование контента по вертикали */
            flex-direction: column;
            /* Контент (заголовок, тело, футер) располагается в колонку */
        }

        .modal-content {
            /* Общий класс для контента внутри модального окна (фото, видео и т.д.) */
            display: none;
            /* Изначально контент скрыт (показывается нужный тип через JS) */
            max-width: 90%;
            /* Максимальная ширина 90% от ширины экрана */
            max-height: 80%;
            /* Максимальная высота 80% от высоты экрана */
            width: auto;
            /* Ширина подстраивается под контент */
            height: auto;
            /* Высота подстраивается под контент */
            border-radius: 4px;
            /* Небольшое скругление углов */
        }

        #modalIframe {
            /* Стиль для iframe в модальном окне */
            display: block;
            /* Отображается как блочный элемент */
            background-color: #000;
            /* Черный фон на случай, если контент грузится долго */
            border-radius: 8px;
            /* Скругленные углы */
            max-width: 95vw;
            /* Максимальная ширина 95% от ширины viewport */
            max-height: 90vh;
            /* Максимальная высота 90% от высоты viewport */
        }

        #jitsi-container {
            width: 90%;
            height: 90%;
            max-width: 1280px;
        }

        #modalText {
            /* Стиль для текстового блока в модальном окне */
            background-color: #fff;
            /* Белый фон */
            padding: 25px;
            /* Внутренние отступы */
            color: #333;
            /* Темный цвет текста */
            overflow-y: auto;
            /* Прокрутка, если текст не помещается */
            line-height: 1.6;
            /* Межстрочный интервал */
        }

        .modal-close {
            /* Стиль для кнопки "крестик" (закрыть) */
            position: absolute;
            /* Абсолютное позиционирование в углу модального окна */
            top: 20px;
            /* Отступ сверху */
            right: 35px;
            /* Отступ справа */
            color: #fe0202;
            /* Ярко-красный цвет */
            font-size: 40px;
            /* Большой размер */
            font-weight: bold;
            /* Жирное начертание */
            cursor: pointer;
            /* Курсор-рука */
            z-index: 1001;
            /* Поверх контента модального окна */
        }

        .modal-header,
        /* Стили для заголовка и подвала модального окна */
        .modal-footer {
            color: white;
            /* Белый цвет текста */
            text-align: center;
            /* Центрирование */
            padding: 5px 15px;
            /* Небольшие отступы */
            max-width: 90%;
            /* Ограничение ширины */
            box-sizing: border-box;
            /* padding не влияет на ширину */
            font-size: clamp(0.8rem, 2vw, 1.1em);
            /* Адаптивный размер шрифта */
        }

        /* --- СТИЛИ ДЛЯ МОДАЛЬНОГО ОКНА БРОНИРОВАНИЯ --- */
        #iframe-wrapper {
            /* Контейнер-обертка для iframe бронирования */
            position: relative;
            /* Относительное позиционирование для дочернего крестика */
            width: 95%;
            /* Ширина 95% */
            max-width: 700px;
            /* Но не более 700px */
            background-color: #ffffff;
            /* Белый фон */
            border-radius: 8px;
            /* Скругленные углы */
            padding: 15px;
            /* Внутренние отступы */
            box-sizing: border-box;
            /* padding не влияет на ширину */
            transition: height 0.3s ease;
            /* Плавное изменение высоты (подстраивается под контент iframe) */
        }

        #bookingFrame {
            /* Сам iframe с формой бронирования */
            width: 100%;
            /* На всю ширину обертки */
            height: 100%;
            /* На всю высоту обертки */
            border: none;
            /* Без рамки */
        }

        /* --- СТИЛИ ДЛЯ ПАНЕЛИ АДМИНИСТРАТОРА --- */
        #admin-panel {
            /* Контейнер для панели с ошибками */
            position: fixed;
            /* Фиксированное положение в углу экрана */
            bottom: 10px;
            /* Отступ снизу */
            left: 10px;
            /* Отступ слева */
            z-index: 9999;
            /* Почти самый высокий z-index */
            background-color: rgba(255, 221, 221, 0.95);
            /* Полупрозрачный красный фон */
            border: 2px solid #db4437;
            /* Красная рамка */
            border-radius: 8px;
            /* Скругленные углы */
            padding: 15px;
            /* Внутренние отступы */
            max-width: 400px;
            /* Максимальная ширина */
        }

        #admin-panel h4 {
            /* Заголовок в панели */
            margin: 0 0 10px 0;
            /* Отступ только снизу */
            color: #b71c1c;
            /* Темно-красный цвет */
        }

        #admin-panel ul {
            /* Список ошибок */
            margin: 0;
            /* Убирает внешние отступы */
            padding-left: 20px;
            /* Добавляет отступ слева для маркеров */
        }

        #admin-panel li {
            /* Элемент списка ошибок */
            margin-bottom: 5px;
            /* Отступ между элементами */
        }

        /* --- НОВЫЕ СТИЛИ ДЛЯ КОНСТРУКТОРА АДМИНИСТРАТОРА --- */
        #edit-config-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10001;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 18px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, background-color 0.2s;
        }

        #edit-config-btn:hover {
            transform: scale(1.05);
            background-color: #0056b3;
        }

        /* --- СТИЛИ ДЛЯ НОВОЙ АДМИНКИ УПРАВЛЕНИЯ ЗАПАСАМИ (ЗАДАЧА 3) --- */
        #stock-manager-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 10001;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 18px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, background-color 0.2s;
        }

        #stock-manager-btn:hover {
            transform: scale(1.05);
            background-color: #218838;
        }

        #admin-config-modal,
        #stock-manager-modal,
        #stock-instruction-modal {
            display: none;
            z-index: 10002;
        }

        .admin-modal-content {
            background-color: #f8f9fa;
            color: #212529;
            padding: 20px;
            border-radius: 8px;
            width: 95%;
            max-width: 1200px;
            height: 95vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        }

        .stock-manager-modal-content {
            background-color: #ffffff;
            color: #212529;
            padding: 20px;
            border-radius: 8px;
            width: 95%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        }

        .stock-manager-list {
            margin-top: 15px;
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 4px;
        }

        .stock-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px dashed #eee;
        }

        .stock-item:last-child {
            border-bottom: none;
        }

        .stock-item-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stock-item-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
        }

        .stock-item-title {
            font-weight: 500;
        }

        /* Стили для чекбокса */
        .stock-checkbox-container {
            position: relative;
            display: block;
            cursor: pointer;
            font-size: 22px;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            margin-right: 10px;
        }

        .stock-checkbox-container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
            height: 0;
            width: 0;
        }

        .checkmark {
            position: absolute;
            top: -10px;
            left: -35px;
            height: 25px;
            width: 25px;
            background-color: #eee;
            border-radius: 4px;
            transition: 0.2s;
        }

        .stock-checkbox-container input:checked~.checkmark {
            background-color: #2196F3;
        }

        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        .stock-checkbox-container input:checked~.checkmark:after {
            display: block;
        }

        .stock-checkbox-container .checkmark:after {
            left: 9px;
            top: 5px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 3px 3px 0;
            -webkit-transform: rotate(45deg);
            -ms-transform: rotate(45deg);
            transform: rotate(45deg);
        }

        /* Конец стилей для чекбокса */


        .admin-modal-content h3 {
            margin-top: 0;
        }

        .admin-modal-top-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .admin-version-control,
        .admin-tools {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .admin-version-control select,
        .admin-version-control button,
        .admin-tools button {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* Стили для редактора CodeMirror */
        .CodeMirror {
            border: 1px solid #ccc;
            height: auto;
            flex-grow: 1;
            font-size: 14px;
            border-radius: 4px;
        }

        .CodeMirror-lint-marker-error {
            background-image: none;
        }

        .admin-modal-bottom-panel {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .admin-modal-bottom-panel .left-buttons,
        .admin-modal-bottom-panel .right-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .admin-modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0069d9;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        /* Стили для плавающего окна-блокнота */
        #scratchpad-window {
            display: none;
            position: fixed;
            z-index: 10003;
            background-color: #f1f1f1;
            border: 1px solid #d3d3d3;
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            width: 600px;
            height: 400px;
            top: 20%;
            left: 20%;
            resize: both;
            /* Позволяет изменять размер */
            overflow: hidden;
            /* Скрывает содержимое, выходящее за рамки */
            display: flex;
            flex-direction: column;
        }

        #scratchpad-header {
            padding: 10px;
            cursor: move;
            z-index: 10;
            background-color: #2196F3;
            color: white;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #scratchpad-header-title {
            font-weight: bold;
        }

        #scratchpad-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
        }

        #scratchpad-editor-container {
            padding: 5px;
            flex-grow: 1;
            display: flex;
            /* Для корректной работы CodeMirror */
        }

        #scratchpad-window .CodeMirror {
            flex-grow: 1;
            /* Растягивает редактор */
            height: 100%;
        }

        /* --- СТИЛИ ДЛЯ НИЖНЕЙ ПАНЕЛИ УПРАВЛЕНИЯ --- */
        .controls {
            /* Основной контейнер панели управления */
            flex-shrink: 0;
            /* Запрещает панели сжиматься */
            display: flex;
            /* Включает flexbox */
            flex-direction: column;
            /* Элементы в колонку */
            justify-content: center;
            /* Центрирование по вертикали */
            align-items: center;
            /* Центрирование по горизонтали */
            padding: 10px 15px;
            /* Внутренние отступы */
            background: #f1f1f1;
            /* Светло-серый фон */
            border-top: 1px solid #ddd;
            /* Тонкая линия сверху */
            box-sizing: border-box;
            /* padding не влияет на размеры */
        }

        .controls-label {
            /* Стиль для заголовка маршрута в панели */
            color: #555;
            /* Темно-серый цвет */
            margin-bottom: 8px;
            /* Отступ снизу */
            font-weight: bold;
            /* Жирный шрифт */
            text-align: center;
            /* Центрирование текста */
            font-size: clamp(1.2rem, 2.5vw, 1.4em);
            /* Адаптивный размер шрифта */
            max-width: 100%;
            /* Максимальная ширина */
            word-break: break-word;
            /* Перенос длинных слов */
            overflow-wrap: break-word;
            /* Аналогично */
            hyphens: auto;
            /* Автоматические переносы */
            min-width: 0;
            /* Для корректной работы flex */
        }

        .controls-buttons {
            /* Контейнер для группы кнопок управления */
            display: flex;
            /* Включает flexbox */
            justify-content: center;
            /* Центрирование по горизонтали */
            align-items: center;
            /* Центрирование по вертикали */
            width: 100%;
            /* На всю ширину */
            gap: clamp(10px, 3vw, 25px);
            /* Адаптивное расстояние между кнопками */
            flex-wrap: wrap;
            /* Перенос кнопок на новую строку */
        }

        .button-wrapper {
            /* Обертка для кнопки и ее подписи */
            display: flex;
            /* Включает flexbox */
            flex-direction: column;
            /* Элементы в колонку */
            align-items: center;
            /* Центрирование по горизонтали */
            gap: 4px;
            /* Маленький отступ между кнопкой и подписью */
        }

        .button-label {
            /* Стиль для подписи под кнопкой */
            font-size: clamp(1.0rem, 1.8vw, 1.2rem);
            /* Адаптивный размер шрифта */
            color: #555;
            /* Темно-серый цвет */
            text-align: center;
            /* Центрирование */
            line-height: 1.3;
            /* Межстрочный интервал */
        }

        .controls button {
            /* Общий стиль для кнопок в панели управления */
            color: white;
            /* Белый цвет иконки/текста */
            border: none;
            /* Без рамки */
            border-radius: 50%;
            /* Круглая форма */
            cursor: pointer;
            /* Курсор-рука */
            display: flex;
            /* Для центрирования контента */
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s, transform 0.3s;
            /* Плавные переходы */
        }

        .controls button:hover {
            /* Эффект при наведении */
            transform: scale(1.1);
            /* Увеличение */
        }

        #playPauseBtn {
            /* Стиль для кнопки Play/Pause */
            background: #4285F4;
            /* Синий цвет */
            width: 40px;
            /* Ширина */
            height: 40px;
            /* Высота */
            font-size: 20px;
            /* Размер иконки (текстовой) */
        }

        .nav-btn {
            /* Стиль для кнопок навигации (вперед/назад) */
            background: #757575;
            /* Серый цвет */
            width: 40px;
            /* Ширина */
            height: 40px;
            /* Высота */
            font-size: 20px;
            /* Размер иконки */
        }

        #bookingBtn {
            /* Стиль для кнопки бронирования */
            background: #4CAF50;
            /* Зеленый цвет */
            width: 40px;
            /* Ширина */
            height: 40px;
            /* Высота */
            font-size: 20px;
            /* Размер иконки */
        }

        #conferenceBtn {
            background: #e63946;
            /* Яркий красный цвет */
            width: 40px;
            height: 40px;
            font-size: 20px;
        }

        /* --- НОВЫЕ СТИЛИ ДЛЯ КНОПОК МЕССЕНДЖЕРОВ В НИЖНЕМ МЕНЮ (ЗАДАЧА 1) --- */
        #telegramBtn {
            background: #0088cc;
            /* Telegram blue */
            width: 40px;
            height: 40px;
        }

        #whatsappBtn {
            background: #25D366;
            /* WhatsApp green */
            width: 40px;
            height: 40px;
        }

        #instagramBtn {
            background: radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%, #d6249f 60%, #285AEB 90%);
            /* Instagram gradient */
            width: 40px;
            height: 40px;
            overflow: hidden;
            /* Скрывает градиентный фон у svg, если он есть */
            box-shadow: 0 0 0 2px white inset;
            /* Белая обводка */
        }

        #instagramBtn svg {
            /* Для инстаграма используем белый цвет для иконки */
            fill: white;
        }

        /* ------------------------------------------------------------------------ */


        #pageIndicator {
            /* Стиль для индикатора страниц (напр. "1 / 5") */
            font-size: 1.2em;
            /* Размер шрифта */
            font-weight: bold;
            /* Жирный шрифт */
            color: #333;
            /* Темный цвет */
            min-width: 50px;
            /* Минимальная ширина, чтобы не прыгал при смене цифр */
            text-align: center;
            /* Центрирование */
        }

        /* --- СТИЛИ ДЛЯ КАРУСЕЛИ В МОДАЛЬНОМ ОКНЕ --- */
        #modalCarousel {
            /* Контейнер карусели */
            display: flex;
            /* Включает flexbox */
            flex-direction: row;
            /* Элементы в ряд */
            justify-content: space-between;
            /* Расстояние между элементами */
            align-items: center;
            /* Выравнивание по центру */
            width: 95%;
            /* Ширина */
            max-width: 1280px;
            /* Максимальная ширина */
            height: 90%;
            /* Высота */
            gap: 15px;
            /* Отступ между кнопками и картинкой */
        }

        #carouselIframeWrapper {
            /* Обертка для iframe внутри карусели */
            flex-grow: 1;
            /* Занимает все доступное пространство */
            width: 100%;
            /* Ширина */
            height: 100%;
            /* Высота */
            display: flex;
            /* Для центрирования iframe */
            justify-content: center;
            align-items: center;
            overflow: hidden;
            /* Скрывает части iframe, выходящие за пределы при масштабировании */
            position: relative;
            /* Относительное позиционирование */
            z-index: 1;
            /* Слой для iframe */
        }

        #carouselIframe {
            /* Сам iframe с картинкой */
            flex-shrink: 0;
            /* Запрещает сжиматься */
            border: none;
            /* Без рамки */
            border-radius: 8px;
            /* Скругленные углы */
            transition: transform 0.3s ease;
            /* Плавный переход для масштабирования */
            transform-origin: center center;
            /* Точка трансформации - центр */
        }

        .carousel-nav {
            /* Кнопки "вперед/назад" в карусели */
            flex-shrink: 0;
            /* Запрещает сжиматься */
            background: rgba(0, 0, 0, 0.5);
            /* Полупрозрачный фон */
            border: none;
            /* Без рамки */
            color: white;
            /* Белый цвет стрелок */
            font-size: 3em;
            /* Большой размер стрелок */
            cursor: pointer;
            /* Курсор-рука */
            padding: 0 20px;
            /* Отступы для увеличения кликабельной области */
            border-radius: 8px;
            /* Скругление */
            user-select: none;
            /* Запрещает выделение текста стрелок */
            height: 80%;
            /* Высота кнопок */
            position: relative;
            /* Относительное позиционирование */
            z-index: 2;
            /* Поверх iframe */
        }

        .carousel-nav:hover {
            /* Эффект при наведении */
            background: rgba(0, 0, 0, 0.8);
            /* Фон темнее */
        }

        @media (max-width: 768px) {

            /* Адаптивные стили для карусели на мобильных устройствах */
            #modalCarousel {
                /* Контейнер карусели */
                flex-direction: row;
                /* Направление остается row */
                flex-wrap: wrap;
                /* Разрешает перенос элементов */
                justify-content: center;
                /* Центрирование */
                align-items: center;
                /* Центрирование */
                gap: 15px;
                /* Отступ */
            }

            #carouselIframeWrapper {
                /* Обертка для картинки */
                order: 1;
                /* Картинка будет первой */
                width: 100%;
                /* На всю ширину */
                height: 80%;
                /* 80% высоты */
            }

            #modalCarousel .carousel-nav.prev,
            /* Кнопки навигации */
            #modalCarousel .carousel-nav.next {
                order: 2;
                /* Кнопки будут вторыми (под картинкой) */
                font-size: 2em;
                /* Размер стрелок меньше */
                background: rgba(0, 0, 0, 0.5);
                /* Фон */
                border-radius: 50%;
                /* Круглые кнопки */
                height: 45px;
                /* Высота */
                width: 45px;
                /* Ширина */
                padding: 0;
                /* Без отступов */
                display: flex;
                /* Для центрирования стрелки */
                align-items: center;
                justify-content: center;
                margin-top: 5px;
                /* Небольшой отступ сверху */
            }
        }

        /* --- СТИЛИ ДЛЯ РЕЖИМА "ЛЕНТЫ" (FEED MODE) --- */
        .feed-mode {
            /* Класс, добавляемый к body для включения режима ленты */
            height: auto;
            /* Высота автоматическая, по контенту */
            overflow-y: auto;
            /* Показывает вертикальную прокрутку */
            overflow-x: hidden;
            /* Скрывает горизонтальную */
        }

        .feed-mode .content-view {
            /* Экраны в режиме ленты */
            display: block !important;
            /* Всегда видимы как блочные элементы (переопределяет display: none) */
            position: relative;
            /* Обычное относительное позиционирование */
            height: auto;
            /* Высота по контенту */
        }

        .feed-mode #cover-view {
            /* Экран обложки в режиме ленты */
            height: 100vh;
            /* Занимает первый экран по высоте */
            height: 100svh;
            /* Аналогично, для мобильных */
        }

        .feed-mode .page {
            /* Страницы в режиме ленты */
            position: relative;
            /* Обычное относительное позиционирование */
            opacity: 1 !important;
            /* Всегда видимы */
            visibility: visible !important;
            /* Всегда активны */
            margin-bottom: 10px;
            /* Отступ между страницами-блоками */
            height: auto;
            /* Высота по контенту */
        }

        .feed-mode .page details {
            /* Используется тег <details> для создания сворачиваемых блоков */
            width: 100%;
            /* На всю ширину */
            border: 1px solid #e0e0e0;
            /* Светлая рамка */
            border-radius: 8px;
            /* Скругление */
            box-sizing: border-box;
            /* Рамка не влияет на ширину */
        }

        .feed-mode .page details[open] {
            /* Когда блок раскрыт */
            min-height: 80vh;
            /* Минимальная высота, чтобы было удобно читать */
            padding-bottom: 80px;
            /* Отступ снизу, чтобы контент не перекрывался панелью управления */
        }

        .feed-mode .controls {
            /* Панель управления в режиме ленты */
            position: sticky;
            /* "Прилипает" к низу экрана при прокрутке */
            bottom: 0;
            /* К низу */
            z-index: 1000;
            /* Поверх контента страниц */
            width: 100%;
            /* На всю ширину */
        }

        .feed-mode .page summary {
            /* Заголовок сворачиваемого блока */
            padding: 15px;
            /* Отступы */
            background-color: #f1f1f1;
            /* Светло-серый фон */
            border-radius: 8px;
            /* Скругление */
            font-weight: bold;
            /* Жирный шрифт */
            font-size: 1.1em;
            /* Размер шрифта */
            cursor: pointer;
            /* Курсор-рука */
            transition: background-color 0.2s;
            /* Плавный переход фона */
            list-style: none;
            /* Убирает стандартный маркер-стрелку */
            position: relative;
            /* Для позиционирования кастомной стрелки */
        }

        .feed-mode .page summary:hover {
            /* Эффект при наведении */
            background-color: #e0e0e0;
            /* Фон темнее */
        }

        .feed-mode .page summary::before {
            /* Псевдоэлемент для кастомной стрелки */
            content: '▼';
            /* Символ стрелки */
            position: absolute;
            /* Абсолютное позиционирование */
            right: 20px;
            /* Справа */
            transition: transform 0.2s;
            /* Плавный поворот */
        }

        .feed-mode .page details:not([open])>summary::before {
            /* Когда блок свернут */
            transform: rotate(-90deg);
            /* Поворачивает стрелку влево */
        }

        .feed-mode .page details>.page-buttons-container {
            /* Контейнер кнопок внутри <details> */
            margin-top: 20px;
            /* Отступ сверху */
        }

        /* --- СТИЛИ ДЛЯ ВСТРАИВАЕМЫХ В ТЕКСТ МЕДИА-ЭЛЕМЕНТОВ --- */
        .embedded-media {
            /* Общий класс для встраиваемых фото и видео */
            max-width: 100%;
            /* Максимальная ширина - 100% от родительского контейнера */
            height: auto;
            /* Высота подстраивается автоматически */
            display: block;
            /* Отображается как блочный элемент */
            margin: 15px auto;
            /* Отступы сверху/снизу и центрирование по горизонтали */
            border-radius: 8px;
            /* Скругленные углы */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            /* Легкая тень */
        }

        .embedded-media.align-left {
            /* Для выравнивания по левому краю с обтеканием текста */
            float: left;
            /* Обтекание справа */
            margin-right: 15px;
            /* Отступ справа от текста */
            margin-left: 0;
            /* Сброс отступа слева */
        }

        .embedded-media.align-right {
            /* Для выравнивания по правому краю */
            float: right;
            /* Обтекание слева */
            margin-left: 15px;
            /* Отступ слева от текста */
            margin-right: 0;
            /* Сброс отступа справа */
        }

        .embedded-media.size-small {
            /* Маленький размер */
            width: 30%;
            /* Ширина 30% от родителя */
            max-width: 200px;
            /* Но не более 200px */
        }

        .embedded-media.size-medium {
            /* Средний размер */
            width: 50%;
            /* Ширина 50% */
            max-width: 400px;
            /* Но не более 400px */
        }

        .embedded-media.size-large {
            /* Большой размер */
            width: 100%;
            /* На всю ширину */
        }

        .reels-style {
            /* Стиль для вертикальных видео (формат Reels/Shorts) */
            max-width: 300px;
            /* Максимальная ширина */
            aspect-ratio: 9 / 16;
            /* Соотношение сторон 9:16 */
            width: 50%;
            /* Ширина 50% (можно настроить) */
            height: auto;
            /* Высота автоматическая */
        }

        .embedded-audio {
            /* Стиль для встраиваемого аудио плеера */
            width: 100%;
            /* На всю ширину */
            margin: 15px 0;
            /* Отступы сверху и снизу */
        }

        .page p::after {
            /* Псевдоэлемент для очистки потока float */
            content: "";
            /* Пустое содержимое */
            display: table;
            /* Отображается как таблица */
            clear: both;
            /* Отменяет обтекание (float) для последующих элементов */
        }

        /* --- СТИЛИ ДЛЯ НОВОЙ INLINE-КАРУСЕЛИ --- */
        .inline-carousel-container {
            /* Контейнер для горизонтальной прокрутки изображений */
            overflow-x: auto;
            /* Включает горизонтальную прокрутку, если контент не помещается */
            white-space: nowrap;
            /* Запрещает перенос дочерних элементов (картинок) на новую строку */
            padding: 10px 0;
            /* Небольшой вертикальный отступ */
            -webkit-overflow-scrolling: touch;
            /* Обеспечивает плавную прокрутку на iOS */
            scrollbar-width: thin;
            /* Делает полосу прокрутки тонкой в Firefox */
        }

        .inline-carousel-container::-webkit-scrollbar {
            /* Стиль для полосы прокрутки в Chrome/Safari */
            height: 8px;
            /* Высота полосы прокрутки */
        }

        .inline-carousel-container::-webkit-scrollbar-thumb {
            /* Стиль для ползунка прокрутки */
            background: #ccc;
            /* Светло-серый цвет */
            border-radius: 4px;
            /* Скругление */
        }

        .inline-carousel-img {
            /* Стиль для каждого изображения в inline-карусели */
            display: inline-block;
            /* Отображает картинки в одну линию */
            height: 150px;
            /* Фиксированная высота для единообразия */
            width: auto;
            /* Ширина подстраивается для сохранения пропорций */
            margin-right: 10px;
            /* Отступ между картинками */
            border-radius: 8px;
            /* Скругленные углы */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            /* Легкая тень */
            vertical-align: middle;
            /* Выравнивает изображения по центру строки */
        }

        /* --- УЛУЧШЕНИЯ РЕДАКТОРА КОНФИГУРАЦИИ --- */

        /* Задача 2: Улучшение видимости выделения */
        .CodeMirror-selected {
            background-color: rgba(83, 136, 255, 0.45) !important;
        }

        /* Задача 1: Подсветка синим цветом значений для определенных ключей */
        .cm-custom-blue {
            color: #5599FF !important;
        }

        /* --- НОВЫЕ СТИЛИ ДЛЯ КАРТОЧЕК ТОВАРОВ И СЕТКИ --- */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            margin-top: 15px;
            padding-bottom: 20px;
        }

        .product-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .product-card img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .product-card h3 {
            font-size: 1em;
            margin: 0 0 5px 0;
            color: #333;
        }

        .product-card .price {
            font-weight: bold;
            color: #E91E63;
            margin-bottom: 10px;
        }

        /* Стиль для кнопки WhatsApp (переименованная кнопка buy-btn) */
        .whatsapp-btn {
            background-color: #25D366;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.9em;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s;
        }

        .whatsapp-btn:hover {
            background-color: #128C7E;
        }

        /* Новый стиль для кнопки Telegram */
        .telegram-btn {
            background-color: #0088cc;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.9em;
            cursor: pointer;
            width: 100%;
            margin-bottom: 5px;
            transition: background-color 0.2s;
        }

        .telegram-btn:hover {
            background-color: #0077b5;
        }

        /* Стили для новой кнопки Описание */
        .desc-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.9em;
            cursor: pointer;
            width: 100%;
            margin-bottom: 5px;
            /* Отступ снизу для разделения с кнопкой заказа */
            transition: background-color 0.2s;
        }

        .desc-btn:hover {
            background-color: #0b7dda;
        }

        .sub-page-details {
            margin-bottom: 10px;
            border: 1px solid #eee;
            border-radius: 6px;
            overflow: hidden;
        }

        .sub-page-details summary {
            background-color: #fafafa;
            padding: 10px 15px;
            font-weight: 500;
            font-size: 1em;
        }

        .sub-page-details[open] {
            padding-bottom: 15px;
        }

        /* --- СТИЛИ ДЛЯ ГАЛЕРЕИ В МОДАЛЬНОМ ОКНЕ ТОВАРА --- */
        .product-gallery-container {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding: 10px 0;
            margin-top: 20px;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
        }

        .product-gallery-container::-webkit-scrollbar {
            height: 6px;
        }

        .product-gallery-container::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

        .product-gallery-item {
            height: 150px;
            width: auto;
            border-radius: 4px;
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            object-fit: contain;
            background: #f9f9f9;
        }

        .product-gallery-video {
            height: 150px;
            width: 260px;
            border-radius: 4px;
            flex-shrink: 0;
            background: #000;
        }

        /* --- СТИЛИ ДЛЯ РЕЖИМА ПРЕЗЕНТАЦИИ --- */
        .presentation-mode-btn {
            background-color: #9c27b0;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            margin-bottom: 15px;
            transition: background-color 0.2s;
            font-weight: bold;
        }

        .presentation-mode-btn:hover {
            background-color: #7b1fa2;
        }

        .presentation-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
            box-sizing: border-box;
        }

        .slide-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .slide-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .slide-type {
            font-size: 0.8em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .slide-number {
            font-weight: bold;
            color: #9c27b0;
            font-size: 1.2em;
        }

        .slide-title {
            font-size: 1.5em;
            color: #333;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .slide-text {
            font-size: 1.1em;
            line-height: 1.6;
            color: #444;
            margin-bottom: 20px;
            text-align: left;
            width: 100%;
        }

        .slide-media {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .slide-script-box {
            background-color: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }

        .slide-script-label {
            font-weight: bold;
            color: #1976D2;
            margin-bottom: 5px;
            display: block;
            font-size: 0.9em;
        }

        .slide-prompt {
            font-size: 0.8em;
            color: #888;
            margin-top: 20px;
            font-style: italic;
            border-top: 1px dashed #ccc;
            padding-top: 10px;
            width: 100%;
        }

        .presentation-controls {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            padding-top: 10px;
        }

        .presentation-nav-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .presentation-nav-btn.prev {
            background-color: #757575;
            color: white;
        }

        .presentation-nav-btn.next {
            background-color: #2196F3;
            color: white;
        }

        .presentation-nav-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <div id="cover-view" class="content-view">
        <div id="tooltip-box"></div>
    </div>
    <div id="book-view" class="content-view">
        <div class="page-viewer"></div>
    </div>
    <div class="controls">
        <div id="main-title" class="controls-label"></div>
        <div class="controls-buttons">
            <div class="button-wrapper" id="prevBtnWrapper">
                <button id="prevBtn" class="nav-btn">◄</button>
                <span class="button-label">назад</span>
            </div>
            <div class="button-wrapper" id="playPauseBtnWrapper">
                <button id="playPauseBtn">▶</button>
                <span class="button-label">слушать</span>
            </div>
            <span id="pageIndicator"></span>
            <div class="button-wrapper" id="nextBtnWrapper">
                <button id="nextBtn" class="nav-btn">►</button>
                <span class="button-label">вперёд</span>
            </div>
            <div class="button-wrapper" id="bookingBtnWrapper">
                <button id="bookingBtn" title="Заказать">🛒</button>
                <span class="button-label">Заказать</span>
            </div>
            <div class="button-wrapper" id="conferenceBtnWrapper">
                <button id="conferenceBtn" title="Видеоконференция">📹</button>
                <span class="button-label">видеосвязь</span>
            </div>

            <div class="button-wrapper" id="telegramBtnWrapper">
                <button id="telegramBtn" title="Telegram">
                    <svg viewBox="0 0 24 24" fill="white" width="24" height="24">
                        <path d="M18.3 5.3l-1.3 6.4-3.8 3.7-1.8 1.8-1.5 1.5-1.5-1.5-2.2-2.2L3 10.5 19.5 3z"
                            style="fill-rule:evenodd;clip-rule:evenodd;fill:#fff;stroke-linejoin:round;stroke-width:1.5;stroke:#fff;" />
                        <path d="M12 18.2l-1.8-1.8 6.5-6.5L18.3 5.3 12 18.2z"
                            style="fill:#54a9eb;fill-rule:evenodd;clip-rule:evenodd;" />
                        <path d="M18.3 5.3L12 18.2 5.7 5.3 18.3 5.3z"
                            style="fill:#b0d3e5;fill-rule:evenodd;clip-rule:evenodd;" />
                    </svg>
                </button>
                <span class="button-label">Telegram</span>
            </div>
            <div class="button-wrapper" id="whatsappBtnWrapper">
                <button id="whatsappBtn" title="WhatsApp">
                    <svg viewBox="0 0 24 24" fill="white" width="24" height="24">
                        <path
                            d="M12 0c6.627 0 12 5.373 12 12s-5.373 12-12 12S0 18.627 0 12 5.373 0 12 0zm0 3c-4.97 0-9 4.03-9 9 0 1.63 0.44 3.16 1.22 4.54l-1.29 4.86 5.03-1.33A8.995 8.995 0 0 0 12 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm4.5 11.5c-.25.5-.75.75-1.25.75-.5 0-1-.25-1.25-.5l-.75-.5c-.5-.25-1.5-1.25-2.5-2.25-.75-.75-1.25-1.25-1.5-1.5-.25-.25-.25-.75 0-1.25l.25-.5c.25-.5.5-1 1-1.25.5-.25 1-.25 1.25 0 .25.25.25.5.25.75 0 .25 0 .5-.25.75-.25.25-.5.5-.75.75-.25.25-.5.5-.75.75-.25.25-.25.5 0 .75.25.25 1 .75 2 1.5 1 .75 1.75 1.25 2.25 1.5.25.25.5.25.75 0 .25-.25.5-.5.75-.75.25-.5.5-1 1.25-1.25.75-.25 1.5 0 2 .25.5.25.75.5 1 .75l.25.5c.25.5.25 1 0 1.5z"
                            fill-rule="evenodd" />
                    </svg>
                </button>
                <span class="button-label">WhatsApp</span>
            </div>
            <div class="button-wrapper" id="instagramBtnWrapper">
                <button id="instagramBtn" title="Instagram">
                    <svg viewBox="0 0 24 24" fill="white" width="24" height="24">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm3.21 4.41c.64-.1 1.14-.14 1.55.05.41.18.72.48.92.89.2.41.25.91.15 1.55-.1.64-.53 1.13-1.07 1.48-.54.35-1.16.53-1.86.53h-.04c-.69 0-1.31-.18-1.85-.53-.54-.35-.97-.84-1.07-1.48-.1-.64-.05-1.14.15-1.55.2-.41.51-.71.92-.89.41-.18.91-.14 1.55.05zm-.05 5.56c.03 0 .06 0 .1 0h.04c.33 0 .61.08.83.24.22.16.36.36.42.61.06.25.04.53-.06.84-.1.31-.3.57-.59.78-.29.21-.63.31-1.01.31h-.04c-.39 0-.73-.1-1.01-.31-.29-.21-.49-.47-.59-.78-.1-.31-.12-.59-.06-.84.06-.25.2-.45.42-.61.22-.16.5-.24.83-.24zM12 11c-2.48 0-4.5 2.02-4.5 4.5s2.02 4.5 4.5 4.5 4.5-2.02 4.5-4.5-2.02-4.5-4.5-4.5zm0 1c1.93 0 3.5 1.57 3.5 3.5s-1.57 3.5-3.5 3.5-3.5-1.57-3.5-3.5 1.57-3.5 3.5-3.5z" />
                    </svg>
                </button>
                <span class="button-label">Instagram</span>
            </div>
        </div>
    </div>
    <div id="mediaModal" class="modal">
        <span class="modal-close">&times;</span>
        <div class="modal-header"></div>
        <div class="modal-content" id="modalText"></div>
        <img class="modal-content" id="modalPhoto" alt="Изображение">
        <video class="modal-content" id="modalVideo" controls playsinline></video>
        <div class="modal-content" id="jitsi-container"></div>
        <iframe class="modal-content" id="modalIframe" frameborder="0" allowfullscreen></iframe>
        <audio class="modal-content" id="modalAudio" controls></audio>
        <div class="modal-content" id="modalCarousel">
            <button class="carousel-nav prev">&lt;</button>
            <div id="carouselIframeWrapper">
                <iframe src="" frameborder="0" allowfullscreen id="carouselIframe"></iframe>
            </div>
            <button class="carousel-nav next">&gt;</button>
        </div>
        <div class="modal-footer"></div>
    </div>
    <div id="bookingModal" class="modal">
        <div id="iframe-wrapper">
            <span class="modal-close">&times;</span>
            <iframe id="bookingFrame" src="" title="Форма бронирования"></iframe>
        </div>
    </div>
    <audio id="narrationAudio" preload="auto"></audio>

    <div id="stock-manager-modal" class="modal">
    </div>

    <div id="admin-constructor-ui">
        <button id="stock-manager-btn" style="display: none;">📦 Управление Товарами</button>
        <button id="edit-config-btn" style="display: none;">⚙️ Редактор Конфигурации</button>
        <div id="admin-config-modal" class="modal">
            <div class="admin-modal-content">
                <div class="admin-modal-top-panel">
                    <div class="admin-version-control">
                        <select id="versions-dropdown" title="Сохраненные версии конфигурации"></select>
                        <button id="load-version-btn" class="btn-info"
                            title="Загрузить выбранную версию в редактор">Загрузить</button>
                        <button id="delete-version-btn" class="btn-danger"
                            title="Удалить выбранную версию">Удалить</button>
                    </div>
                    <div class="admin-tools">
                        <button id="format-code-btn" class="btn-secondary"
                            title="Отформатировать код">Форматировать</button>
                        <button id="send-to-scratchpad-btn" class="btn-secondary"
                            title="Отправить выделенный код в Блокнот">Отправить в Блокнот</button>
                        <button id="get-from-scratchpad-btn" class="btn-secondary"
                            title="Вставить код из Блокнота вместо выделенного">Вставить из Блокнота</button>
                        <button id="open-scratchpad-btn" class="btn-secondary">Блокнот</button>
                        <button id="undo-btn" class="btn-secondary"
                            title="Отменить последнее действие (Ctrl+Z)">Отменить</button>
                        <button id="redo-btn" class="btn-secondary"
                            title="Вернуть отмененное действие (Ctrl+Y)">Вернуть</button>
                    </div>
                </div>
                <textarea id="config-textarea"></textarea>
                <div class="admin-modal-bottom-panel">
                    <div class="left-buttons">
                        <button id="close-config-btn" class="btn-secondary">Закрыть</button>
                    </div>
                    <div class="right-buttons">
                        <button id="save-as-btn" class="btn-primary"
                            title="Сохранить текущий код как новую именованную версию">Сохранить как...</button>
                        <button id="copy-config-btn" class="btn-warning"
                            title="Скопировать весь код для вставки в HTML-файл">Копировать код</button>
                        <button id="save-config-btn" class="btn-success"
                            title="Применить изменения для теста (сохраняет в браузере до следующего изменения)">Сохранить
                            и Перезагрузить</button>
                    </div>
                </div>
            </div>
        </div>
        <div id="scratchpad-window" style="display: none;">
            <div id="scratchpad-header">
                <span id="scratchpad-header-title">Блокнот для кода</span>
                <button id="scratchpad-close-btn">&times;</button>
            </div>
            <div id="scratchpad-editor-container">
                <textarea id="scratchpad-textarea"></textarea>
            </div>
        </div>
    </div>

    <script id="config-script-tag">
        /* Начало блока JavaScript */

        // =============================================================================
        // --- ГЕНЕРАТОР КАТАЛОГА (ОБНОВЛЕННЫЙ) ---
        // В этой функции добавлена логика для использования уникального ID товара (itemId)
        // для правильной работы функции isItemInStock, которая будет определена в main.js
        // =============================================================================
        function generateSmartCatalog(pageData, isStockPage = false) {
            // ВНИМАНИЕ: Эта функция будет выполнена при загрузке CONFIG

            // Получаем актуальный конфиг, чтобы знать, какие кнопки показывать
            const configStub = window.CONFIG_STUB || {
                productCardButtons: {
                    description: true,
                    orderTelegram: true,
                    orderWhatsapp: true
                }
            };

            // ФУНКЦИЯ-ЗАГЛУШКА: Проверяет, должен ли товар быть в наличии.
            // Реальная логика isItemInStock будет добавлена в main.js и будет
            // использовать localStorage для получения меток от админа.
            const isItemInStock = window.isItemInStock || ((id) => {
                // Если это страница "В НАЛИЧИИ" (СТРАНИЦА 2),
                // и у нас нет глобальной функции, то для заглушки
                // мы покажем все товары, у которых в конфиге стоит isInStock: true
                if (isStockPage) {
                    // ВАЖНОЕ ИЗМЕНЕНИЕ: В ЭТОЙ ФУНКЦИИ БОЛЬШЕ НЕЛЬЗЯ ПОЛАГАТЬСЯ НА window.isItemInStock
                    // ВМЕСТО ЭТОГО МЫ ПРОВЕРЯЕМ isInStock ВНУТРИ visibleItems
                    return true;
                }
                // Если это страница "ПОД ЗАКАЗ" (СТРАНИЦА 4), покажем все
                return true;
            });


            const productCardButtons = configStub.productCardButtons;

            let html = `<h2>${pageData.header}</h2><p>${pageData.subHeader}</p>`;

            if (pageData.categories) {
                pageData.categories.forEach(cat => {
                    // В режиме "В НАЛИЧИИ" показываем категорию только если в ней есть товары в наличии
                    const visibleItems = cat.items.filter(item => {
                        // Если это не страница "В НАЛИЧИИ" (isStockPage=false, т.е. "ПОД ЗАКАЗ"), показываем все товары
                        if (!isStockPage) return true;
                        // Если это страница "В НАЛИЧИИ" (isStockPage=true), показываем только те, что имеют метку isInStock: true В КОНФИГЕ
                        return item.isInStock === true;
                    });

                    if (visibleItems.length > 0) {
                        html += `<details class="sub-page-details"><summary>${cat.name}</summary>`;
                        html += `<div class="product-grid">`;

                        visibleItems.forEach(item => {
                            // Защита от двойных кавычек для HTML атрибутов
                            const safeTitle = (item.title || '').replace(/"/g, '&quot;');
                            // Защита от одинарных кавычек для передачи внутри JS-вызова onclick
                            const jsSafeTitle = safeTitle.replace(/'/g, "\\'");

                            const safePrice = (item.price || '') + (item.currency || '');
                            // Кодируем описание, чтобы сохранить спецсимволы и переносы строк
                            const safeDesc = encodeURIComponent(item.description || '');
                            const safeImage = item.image || 'https://via.placeholder.com/300x200';
                            const safeVideo = item.video || '';
                            // Кодируем дополнительные медиа материалы (массив) в JSON строку
                            const safeMedia = item.media ? encodeURIComponent(JSON.stringify(item.media)) : '';
                            // Кодируем данные презентации, если они есть
                            const safePresentation = item.presentation ? encodeURIComponent(JSON.stringify(item.presentation)) : '';

                            // --- Логика отображения кнопок карточки ---
                            let buttonsHtml = '';

                            // 1. Кнопка Описание
                            if (productCardButtons.description) {
                                buttonsHtml += `<button class="desc-btn" onclick="event.stopPropagation(); window.showProductDetails('${jsSafeTitle}', '${safePrice}', '${safeDesc}', '${safeImage}', '${safeVideo}', '${safeMedia}', '${safePresentation}')">Описание</button>`;
                            }

                            // 2. Кнопка Заказать через Telegram
                            if (productCardButtons.orderTelegram) {
                                buttonsHtml += `<button class="telegram-btn" onclick="event.stopPropagation(); window.orderOneClick('${jsSafeTitle}', 'telegram')">Заказать через Telegram</button>`;
                            }

                            // 3. Кнопка Заказать через WhatsApp
                            if (productCardButtons.orderWhatsapp) {
                                buttonsHtml += `<button class="whatsapp-btn" onclick="event.stopPropagation(); window.orderOneClick('${jsSafeTitle}', 'whatsapp')">Заказать через WhatsApp</button>`;
                            }
                            // --- Конец логики кнопок карточки ---

                            html += `
                        <div class="product-card" onclick="window.showProductDetails('${jsSafeTitle}', '${safePrice}', '${safeDesc}', '${safeImage}', '${safeVideo}', '${safeMedia}', '${safePresentation}')">
                            <img src="${safeImage}" alt="${safeTitle}">
                            <h3>${safeTitle}</h3>
                            <p class="price">${safePrice}</p>
                            ${buttonsHtml}
                        </div>`;
                        });

                        html += `</div></details>`;
                    }
                });
            }
            return html;
        }

        /*--CONFIG_START--*/
        // Используйте этот объект для всей конфигурации.
        // Теперь вы можете оставлять здесь комментарии, и они сохранятся!
        const defaultConfig = {
            //==============================================================//
            //=================== ГЛОБАЛЬНЫЕ НАСТРОЙКИ =====================//
            //==============================================================//

            // true: показывать обложку при загрузке.
            // false: пропускать обложку и сразу открывать первую страницу.
            showCover: false,

            // true: после окончания аудио на последней странице, плеер начнет воспроизведение с первой.
            // false: воспроизведение остановится после окончания последней страницы.
            isContinuousPlayback: false,

            // true: на мобильных устройствах страницы будут отображаться в виде вертикальной ленты (как в соцсетях).
            // false: на мобильных будет режим "книги" с кнопками "вперед/назад".
            mobileFeedMode: true,

            // true: на компьютерах страницы также будут в виде ленты.
            // false: на компьютерах будет режим "книги".
            feedModeForDesktop: true,

            // --- Настройки видеоконференции (Jitsi) ---
            videoConference: {
                // true: включить кнопку видеосвязи на нижней панели.
                enabled: false,
                // Текст под кнопкой видеосвязи.
                buttonText: 'видеосвязь',
                // Уникальное имя комнаты для конференции. Важно, чтобы оно было уникальным для каждого маршрута.
                roomName: 'Route2-VasilisaConference',
                // Всплывающая подсказка при наведении на кнопку.
                tooltip: 'Присоединиться к видео-конференции'
            },

            // URL веб-приложения Google Apps Script для отправки уведомлений о начале видеозвонка.
            notificationScriptUrl: 'https://script.google.com/macros/s/AKfycby6DFzTC1zvZdPQIYHWCFEA8IClHCJZmCfSh3RTIBovCbivc/exec',

            //==============================================================//
            //=================== ОСНОВНАЯ ИНФОРМАЦИЯ ======================//
            //==============================================================//

            // Главный заголовок, который отображается в нижней панели управления.
            mainTitle: 'Василиса | Авторские украшения и Обучение',

            // Прямая ссылка на основной аудиофайл (MP3), который будет озвучивать все страницы.
            audioUrl: 'https://raw.githubusercontent.com/znamenskiialeksei/marmarisyachting/main/2RouteAudio.mp3',

            // Ссылка на веб-приложение Google Apps Script для формы бронирования.
            bookingUrl: 'https://script.google.com/macros/s/AKfycbw_zW9cCs6adluPNaVVm6spv16UwmQ4vAvvFSo5cenzsE8kpJnBAyktHy4zZaIeac_-VA/exec?page=route2',

            // ==============================================================//
            // ========== НОВЫЙ БЛОК: КНОПКИ НИЖНЕГО МЕНЮ (ЗАДАЧА 1) ==========//
            // ==============================================================//
            bottomMenuButtons: {
                // true: показать кнопку "Назад" (на мобильных только в режиме "Книги")
                prev: false,
                // true: показать кнопку "Плей/Пауза"
                playPause: false,
                // true: показать индикатор страниц (например, "1 / 5")
                pageIndicator: false,
                // true: показать кнопку "Вперёд" (на мобильных только в режиме "Книги")
                next: false,
                // true: показать кнопку "Заказать"
                booking: false,
                // true: показать кнопку "Видеосвязь"
                conference: false,
                // НОВЫЕ КНОПКИ МЕССЕНДЖЕРОВ
                telegram: true, // Задача 1
                whatsapp: true, // Задача 1
                instagram: true // Задача 1
            },

            // ==============================================================//
            // ======= НОВЫЙ БЛОК: КНОПКИ В КАРТОЧКАХ ТОВАРОВ (ЗАДАЧА 2) ======//
            // ==============================================================//
            productCardButtons: {
                // true: показать кнопку "Описание"
                description: true,
                // true: показать кнопку "Заказать через Telegram"
                orderTelegram: true,
                // true: показать кнопку "Заказать через WhatsApp" (переименованная кнопка "Заказать")
                orderWhatsapp: true
            },

            //==============================================================//
            //==================== НАСТРОЙКИ ОБЛОЖКИ =======================//
            //==============================================================//

            // Прямая ссылка на фоновое видео для главной страницы (обложки).
            coverVideoUrl: 'https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/oblogka.mp4',

            // Режим масштабирования видео. 'cover' - заполнить весь экран, обрезая лишнее. 'contain' - показать видео целиком.
            coverVideoFitMode: 'contain',

            // Массив текстовых блоков, которые будут отображаться поверх видео на обложке.
            coverTexts: [{
                // Текст для отображения.
                text: 'Vasilisa',
                // Всплывающая подсказка.
                tooltip: 'Уникальные украшения и Обучение',
                // Позиция от верхнего края (в процентах).
                top: '5%',
                // Позиция от левого края (в процентах).
                left: '45%',
                // true - показать, false - скрыть.
                visible: false
            }],

            // Настройки эффекта "пульсации" для кнопок на обложке.
            pulsingEffect: {
                enabled: true,      // true - включить эффект.
                fadeInDuration: 0.5, // Длительность появления (в секундах).
                visibleDuration: 4.0,// Длительность в видимом состоянии.
                fadeOutDuration: 0.5,// Длительность исчезновения.
                hiddenDuration: 3.0  // Пауза перед следующим появлением.
            },

            // Кнопки для быстрой связи (мессенджеры) на обложке.
            contactButtons: [{
                visible: true,      // true - показать кнопку.
                pulsing: true,      // true - применить эффект пульсации.
                url: 'https://wa.me/79213047892?text=Здравствуйте!%20Интересует%20украшение.', // Ссылка для перехода.
                icon: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="12" fill="#25D366"/><text x="12" y="16" font-size="10" text-anchor="middle" fill="white">WA</text></svg>', // Иконка в формате SVG.
                tooltip: 'Написать в WhatsApp',
                top: '90%',
                left: '15%'
            }, {
                visible: true,
                pulsing: true,
                url: 'https://t.me/Vasilisaznamenskaya?text=Здравствуйте!%20Интересует%20украшение.',
                icon: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="12" fill="#0088cc"/><text x="12" y="16" font-size="10" text-anchor="middle" fill="white">TG</text></svg>',
                tooltip: 'Написать в Telegram',
                top: '90%',
                left: '85%'
            }],

            // Кнопка-меню для выбора других маршрутов.
            routeSelector: {
                visible: true,
                pulsing: false,
                icon: '<svg viewBox="0 0 90 40"><rect x="0.5" y="0.5" width="89" height="39" rx="8" fill="#36454F" stroke="#FFFFFF" stroke-width="1"/><text x="45" y="25" font-size="14" font-family="Arial, sans-serif" fill="white" font-weight="bold" text-anchor="middle">Акция</text></svg>',
                tooltip: 'Топ любимые украшения',
                top: '90%',
                left: '50%',
                // Список ссылок в выпадающем меню.
                routes: [{
                    name: 'Маршрут 1: Дневной тур Кумлубюк',
                    url: 'https://www.marmarisyachting.ru/Yacht-Vasilisa-Catalog/Route1'
                }, {
                    name: 'Маршрут 2: Дневной тур с обедом на яхте',
                    url: 'https://www.marmarisyachting.ru/Yacht-Vasilisa-Catalog/Route2'
                }, {
                    name: 'Маршрут 3: Дневной тур Чифтлик',
                    url: 'https://www.marmarisyachting.ru/Yacht-Vasilisa-Catalog/Route3'
                }, {
                    // Специальное действие для открытия модального окна бронирования.
                    name: 'Бронировать тур',
                    action: 'openBooking'
                }, {
                    name: 'Календарь доступности',
                    url: 'https://script.google.com/macros/s/AKfycbw_zW9cCs6adluPNaVVm6spv16UwmQ4vAvvFSo5cenzsE8kpJnBAyktHy4zZaIeac_-VA/exec?page=calendar',
                    target: '_blank' // '_blank' открывает ссылку в новой вкладке.
                }, {
                    name: 'Недельная аренда виллы',
                    url: 'https://www.marmarisyachting.ru/Villa-Turaman'
                }]
            },

            //==============================================================//
            //======================= СТРАНИЦЫ КНИГИ =======================//
            //==============================================================//
            // Это массив, где каждый объект {} - это отдельная страница.
            pages: [

                //==============================================================//
                //=========== СТРАНИЦА 1: ОБО МНЕ (С ВИДЕО) ====================//
                //==============================================================//
                {
                    // true - страница будет показана, false - страница будет скрыта из маршрута.
                    published: true,

                    // Основной текстовый контент страницы. 
                    text: `<h2>Обо мне</h2>
            <video autoplay loop muted playsinline class="embedded-media size-medium align-left" style="border-radius: 8px;">
                <source src="https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/oblogka.mp4" type="video/mp4">
            </video>
            
            <p>Приветствую! </p>
            <p>Я создаю украшения для женщин, которые выбрали себя. Мои изделия — это осязаемое отражение вашей внутренней силы, напоминающее: роскошь достойна вас каждый день. </p>
            <p>А ещё я знаю, как тяжело, когда делаешь и складываешь «в стол». Поэтому я делюсь авторскими технологиями, чтобы ваше любимое дело приносило вам и радость, и стабильный доход. Нам по пути. </p>`,

                    narrationEndTime: 0,
                    collapsible: false,
                    customHeight: 'auto',

                    // Массив кастомных выпадающих меню, которые можно разместить прямо на этой странице.
                    customDropdowns: [{
                        visible: true,
                        pulsing: true,
                        icon: '<svg viewBox="0 0 90 40"><rect x="0.5" y="0.5" width="89" height="39" rx="8" fill="#4CAF50" stroke="#FFFFFF" stroke-width="1"/><text x="45" y="25" font-size="14" font-family="Arial, sans-serif" fill="white" font-weight="bold" text-anchor="middle">Связаться</text></svg>',
                        tooltip: 'Напишите нам',
                        top: '95%',
                        left: '65%',
                        routes: [{
                            name: 'Написать в WhatsApp',
                            url: 'https://wa.me/79213047892?text=Здравствуйте!%20Интересует%20украшение.',
                            target: '_blank'
                        }, {
                            name: 'Написать в Telegram',
                            url: 'https://t.me/Vasilisaznamenskaya?text=Здравствуйте!%20Интересует%20украшение.',
                            target: '_blank'
                        }]
                    }]
                },

                //==============================================================//
                //=========== СТРАНИЦА 2: В НАЛИЧИИ (С УМНЫМ ЗАПОЛНЕНИЕМ) ======//
                // НОВЫЙ КОНТЕНТ: ГЕНЕРИРУЕТСЯ ИЗ ДАННЫХ СТРАНИЦЫ 4 (Задача 2)
                // ИСПРАВЛЕНИЕ ОШИБКИ СИНТАКСИСА: Заменяем IIFE на строковый маркер
                //==============================================================//
                {
                    published: true,
                    collapsedOnLoad: true,
                    collapsible: true,
                    customHeight: 'auto',
                    // ИСПОЛЬЗУЕМ ФУНКЦИЮ generateSmartCatalog ДЛЯ АВТОМАТИЧЕСКОГО СОЗДАНИЯ HTML
                    // МАРКЕР: Текст будет сгенерирован в main.js после полной загрузки CONFIG
                    text: '@@GENERATE_STOCK_CATALOG_FROM_PAGE_4@@',
                    narrationEndTime: 91,
                },

                //==============================================================//
                //=========== СТРАНИЦА 3: МАСТЕР-КЛАССЫ (С УМНЫМ ЗАПОЛНЕНИЕМ) ==//
                // БЕЗ ИЗМЕНЕНИЙ (Индекс 2)
                //==============================================================//
                {
                    published: true,
                    collapsible: true,
                    collapsedOnLoad: true,
                    customHeight: 'auto',
                    text: generateSmartCatalog({
                        header: "Обучение - мастер-классы по вышивке, созданию украшений и созданию контента",
                        subHeader: "Научитесь создавать шедевры своими руками.",
                        categories: [
                            {
                                name: "Мастер-классы<br> по вышивке",
                                items: [
                                    // ТОВАРЫ МАСТЕР-КЛАССОВ НЕ ЗЕРКАЛЯТСЯ (Создаются только на этой странице)
                                    {
                                        id: 'mk-ukrasheniya-feyerverk', // Уникальный ID для товара (не используется для зеркал)
                                        title: "Курс: Украшения-Фейерверк",
                                        price: "50 EUR",
                                        currency: "",
                                        image: "https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/IMG_5276.jpg", // Используем обложку из презентации
                                        description: "Авторская технология создания самого востребованного украшения года. От «В стол» до «Хит продаж».",
                                        // --- НОВЫЙ БЛОК ПРЕЗЕНТАЦИИ ---
                                        presentation: [
                                            {
                                                slideNumber: 1,
                                                type: "Титульный",
                                                header: "От «В стол» до «Хит продаж» 1",
                                                slideText: "Авторская технология создания самого востребованного украшения года.",
                                                speakerScript: "Приветствую. Если вы здесь, значит, вы ищете не просто новое хобби, а способ монетизировать свое творчество. Сегодня я покажу путь от забитого стола до очередей клиентов.",
                                                media: "https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/IMG_5276.jpg",
                                                mediaType: "image",
                                                backgroundPrompt: "Luxury beige silk texture background, soft folds, expensive fabric, high jewelry aesthetic, soft golden lighting, minimalist, elegant, blurred, 8k --ar 9:16"
                                            },
                                            {
                                                slideNumber: 2,
                                                type: "Проблема",
                                                header: "Устали работать «в пустоту»? 2",
                                                slideText: "• Идеальные изделия пылятся в столе.<br>• Нет понимания, что сейчас покупают.<br>• Страх, что опять не купят. 3",
                                                speakerScript: "Я знаю это чувство. Вы вкладываете душу, время и деньги, делаете идеально... но изделия остаются лежать в шкатулке. Проблема не в ваших руках, а в выборе продукта.",
                                                media: "https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/IMG_5281.MOV",
                                                mediaType: "video",
                                                backgroundPrompt: "Abstract background, macro photography of champagne bubbles, soft beige and cream tones, bokeh effect, elegant and sophisticated, negative space for text --ar 9:16"
                                            },
                                            {
                                                slideNumber: 3,
                                                type: "Решение / Технология",
                                                header: "Секрет Трансформации 4",
                                                slideText: "Одна техника = 3 продукта:<br>• Кольцо «Фейерверк»<br>• Серьги<br>• Кулон 5",
                                                speakerScript: "Я даю вам не просто схему кольца. Это конструктор. Освоив эту технику один раз, вы сможете создавать целые коллекции: серьги, кулоны, кольца. Это универсальный навык.",
                                                media: "https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/IMG_5278.MP4",
                                                mediaType: "video",
                                                backgroundPrompt: "Close up texture of cream colored velvet, soft shadows, luxurious feel, clean composition, warm lighting, photorealistic, premium design style --ar 9:16"
                                            },
                                            {
                                                slideNumber: 4,
                                                type: "Оффер (Наполнение)",
                                                header: "Что внутри курса? 6",
                                                slideText: "• 5 пошаговых видео-уроков.<br>• Список материалов (без лишних трат).<br>• Доступ навсегда. 7777",
                                                speakerScript: "Никакой воды. 5 коротких уроков, готовый список покупок, чтобы вы не тратили лишнего. Даже если вы новичок — у вас получится, потому что методика разбита на простые шаги.",
                                                media: "https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/IMG_5277.jpg",
                                                mediaType: "image",
                                                backgroundPrompt: "Abstract light refraction through crystal glass, soft beige and white palette, dreamy atmosphere, elegant blur, high key lighting, minimalist --ar 9:16"
                                            },
                                            {
                                                slideNumber: 5,
                                                type: "Кейс / Social Proof",
                                                header: "Раскупили за 1 час 8",
                                                slideText: "Коллекция на базе этого дизайна была продана на ярмарке за первый час. 9",
                                                speakerScript: "Моя экспертиза в том, что я знаю, что покупают люди10. Дизайн \"Фейерверк\" — это магнит. На последней ярмарке стенд опустел за час. Это украшение продает само себя.",
                                                media: "https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/IMG_5280.MOV",
                                                mediaType: "video",
                                                backgroundPrompt: "Soft focus image of pearl necklace on silk table, extreme close up background, creamy tones, rich texture, old money aesthetic, sophisticated --ar 9:16"
                                            },
                                            {
                                                slideNumber: 6,
                                                type: "Цена и Окупаемость",
                                                header: "Окупаемость: 2 изделия 11",
                                                slideText: "Стоимость МК: 50 EUR 12<br><br>Инвестиция, которая вернется мгновенно.",
                                                speakerScript: "Цена мастер-класса — всего 50 евро. Чтобы \"отбить\" эти вложения и выйти в плюс, вам достаточно продать всего два кольца, сделанных по этому уроку.",
                                                media: "https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/video_2025.mp4", // Placeholder file name inferred
                                                mediaType: "video",
                                                backgroundPrompt: "Morning sunlight passing through sheer curtains, soft shadows on a beige wall, cozy and expensive atmosphere, minimalist background --ar 9:16"
                                            },
                                            {
                                                slideNumber: 7,
                                                type: "Призыв (CTA)",
                                                header: "Ваш старт — сегодня 13",
                                                slideText: "Напишите «ХОЧУ ФЕЙЕРВЕРК», чтобы забрать урок. 14<br><br>Хватит откладывать продажи!",
                                                speakerScript: "Перестаньте делать \"для себя\". Начните делать для клиентов15. Пишите кодовое слово, забирайте урок и уже на этой неделе создайте свой первый хит продаж.",
                                                media: "https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/IMG_5276.jpg",
                                                mediaType: "image",
                                                backgroundPrompt: "Solid expensive beige paper texture, embossed gold lines abstract, very minimalist, plenty of space for large text, centered composition --ar 9:16"
                                            }
                                        ]
                                        // ------------------------------------
                                    },
                                    { id: 'mk-osnovy', title: "МК Основы", price: 1000, currency: "р", image: "https://via.placeholder.com/150", description: "Базовые техники." },
                                    { id: 'mk-braslet', title: "МК Браслет", price: 1200, currency: "р", image: "https://via.placeholder.com/150", description: "Создаем браслет." },
                                    { id: 'mk-sergi', title: "МК Серьги", price: 1200, currency: "р", image: "https://via.placeholder.com/150", description: "Создаем серьги." },
                                    { id: 'mk-koltso', title: "МК Кольцо", price: 1200, currency: "р", image: "https://via.placeholder.com/150", description: "Создаем кольцо." },
                                    { id: 'mk-podveska', title: "МК Подвеска", price: 1200, currency: "р", image: "https://via.placeholder.com/150", description: "Создаем подвеску." }
                                ]
                            },
                            {
                                name: "Мастер-классы по создавнию украшений",
                                items: [
                                    { id: 'mk-slozhny', title: "МК Сложный", price: 2000, currency: "р", image: "https://via.placeholder.com/150", description: "Сложные техники." },
                                    { id: 'mk-obem', title: "МК Объем", price: 2000, currency: "р", image: "https://via.placeholder.com/150", description: "Работа с объемом." },
                                    { id: 'mk-setka', title: "МК Сетка", price: 2000, currency: "р", image: "https://via.placeholder.com/150", description: "Плетение сеткой." },
                                    { id: 'mk-kamni', title: "МК Камни", price: 2000, currency: "р", image: "https://via.placeholder.com/150", description: "Оправа камней." },
                                    { id: 'mk-dizain', title: "МК Дизайн", price: 2000, currency: "р", image: "https://via.placeholder.com/150", description: "Разработка дизайна." }
                                ]
                            },
                            {
                                name: "Индивидуальное обучение вышивке",
                                items: [
                                    { id: 'ind-nastavnichestvo', title: "Наставничество", price: 15000, currency: "р", image: "https://via.placeholder.com/150", description: "Личное ведение." },
                                    { id: 'ind-razbor', title: "Разбор", price: 5000, currency: "р", image: "https://via.placeholder.com/150", description: "Разбор профиля." },
                                    { id: 'ind-konsultatsiya', title: "Консультация", price: 3000, currency: "р", image: "https://via.placeholder.com/150", description: "Ответы на вопросы." },
                                    { id: 'ind-urok-live', title: "Урок Live", price: 4000, currency: "р", image: "https://via.placeholder.com/150", description: "Живой урок." },
                                    { id: 'ind-audit', title: "Аудит", price: 3000, currency: "р", image: "https://via.placeholder.com/150", description: "Аудит бренда." }
                                ]
                            },
                            {
                                name: "Мастер-классы<br> по созданию контента (Reels)",
                                items: [
                                    { id: 'mk-prodazhi', title: "МК Продажи", price: 5000, currency: "р", image: "https://via.placeholder.com/150", description: "Как продавать." },
                                    { id: 'mk-foto', title: "МК Фото", price: 3000, currency: "р", image: "https://via.placeholder.com/150", description: "Фотография изделий." },
                                    { id: 'mk-brend', title: "МК Бренд", price: 4000, currency: "р", image: "https://via.placeholder.com/150", description: "Личный бренд." },
                                    { id: 'mk-insta', title: "МК Инста", price: 3000, currency: "р", image: "https://via.placeholder.com/150", description: "Ведение соцсетей." },
                                    { id: 'mk-teksty', title: "МК Тексты", price: 2000, currency: "р", image: "https://via.placeholder.com/150", description: "Копирайтинг." }
                                ]
                            },
                            {
                                name: "Индивидуальное сопровождение по созданию контента (Reels)",
                                items: [
                                    { id: 'ind-nastavnichestvo-reels', title: "Наставничество", price: 15000, currency: "р", image: "https://via.placeholder.com/150", description: "Личное ведение." },
                                    { id: 'ind-razbor-reels', title: "Разбор", price: 5000, currency: "р", image: "https://via.placeholder.com/150", description: "Разбор профиля." },
                                    { id: 'ind-konsultatsiya-reels', title: "Консультация", price: 3000, currency: "р", image: "https://via.placeholder.com/150", description: "Ответы на вопросы." },
                                    { id: 'ind-urok-live-reels', title: "Урок Live", price: 4000, currency: "р", image: "https://via.placeholder.com/150", description: "Живой урок." },
                                    { id: 'ind-audit-reels', title: "Аудит", price: 3000, currency: "р", image: "https://via.placeholder.com/150", description: "Аудит бренда." }
                                ]
                            },
                            {
                                name: "Материалы",
                                items: [
                                    { id: 'materials-nabor-1', title: "Набор 1", price: 1500, currency: "р", image: "https://via.placeholder.com/150", description: "Набор бусин." },
                                    { id: 'materials-nabor-2', title: "Набор 2", price: 1500, currency: "р", image: "https://via.placeholder.com/150", description: "Набор бисера." },
                                    { id: 'materials-nabor-3', title: "Набор 3", price: 1500, currency: "р", image: "https://via.placeholder.com/150", description: "Набор ниток." },
                                    { id: 'materials-nabor-4', title: "Набор 4", price: 1500, currency: "р", image: "https://via.placeholder.com/150", description: "Набор игл." },
                                    { id: 'materials-nabor-5', title: "Набор 5", price: 1500, currency: "р", image: "https://via.placeholder.com/150", description: "Полный комплект." }
                                ]
                            }
                        ]
                    }),
                    narrationEndTime: 0,
                },

                //==============================================================//
                //=========== СТРАНИЦА 4: ПОД ЗАКАЗ (С УМНЫМ ЗАПОЛНЕНИЕМ) ======//
                // Добавлено: уникальный id и метка isInStock: false для каждого товара
                // ИСПРАВЛЕНИЕ ОШИБКИ СИНТАКСИСА: Заменяем IIFE на строковый маркер
                //==============================================================//
                {
                    published: true,
                    collapsible: true,
                    collapsedOnLoad: true,
                    customHeight: 'auto',
                    // Сохраняем данные в отдельное поле для доступа из СТРАНИЦЫ 2
                    configData: {
                        header: "Украшения и аксессуары под заказ",
                        subHeader: "Эксклюзивные изделия, созданные специально для вас.",
                        categories: [
                            {
                                name: "Сумки и кастом одежды",
                                items: [
                                    {
                                        id: 'sumka-shkatulka-zhelaniy',
                                        isInStock: false, // Метка для админа (Задача 2 и 3)
                                        title: "Мини сумочка «Шкатулка Желаний»",
                                        price: 5600,
                                        currency: "р",
                                        image: "https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Мини сумочка  «Шкатулка Желаний».jpg",
                                        video: "",
                                        media: [
                                            { type: 'photo', url: 'https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Мини сумочка  «Шкатулка Желаний».jpg' },
                                            { type: 'photo', url: 'https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Мини сумочка  «Шкатулка Желаний».jpg' },
                                            { type: 'video', url: 'https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Мини сумочка  «Шкатулка Желаний».mp4' },
                                            { type: 'photo', url: 'https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Мини сумочка  «Шкатулка Желаний».jpg' }
                                        ],
                                        description: `В мире, где личная магия часто остается незаметной, я создала открытый вызов.
                                
                                Это квинтэссенция Haute Couture: миниатюрный размер, но максимально дерзкий эффект.
                                Каждая пайетка и бисеринка пришиты вручную, чтобы создать эффект той самой, неподвластной времени магии шика Chanel.
                                
                                Но это не просто мини-сумочка.
                                Это украшение, которое мгновенно превращает простой образ в произведение искусства.
                                
                                Носите ее как бодичейн, колье или как акцентный пояс. Она — ваш личный, заряженный на исполнение желаний артефакт.
                                Вы будете чувствовать себя не иначе как Королевой: уверенной, исключительной, офигенной.
                                
                                Это аксессуар, который несет в себе ваш смысл.
                                Он говорит миру:
                                "Да, это моя магия. И она всегда при мне."
                                
                                Позвольте себе эту уникальность. — Мини-сумочка «Шкатулка Желаний»: Вышивка пайетками и бисером. Кристаллы и бусины Сваровски. Функциональный/нарядный аксессуар.`
                                    },
                                    { id: 'sumochka-2', isInStock: false, title: "Сумочка 2", price: 4000, currency: "р", image: "https://via.placeholder.com/150", description: "Описание." },
                                    { id: 'sumochka-3', isInStock: false, title: "Сумочка 3", price: 4000, currency: "р", image: "https://via.placeholder.com/150", description: "Описание." },
                                    { id: 'sumochka-4', isInStock: false, title: "Сумочка 4", price: 4000, currency: "р", image: "https://via.placeholder.com/150", description: "Описание." },
                                    { id: 'sumochka-5', isInStock: false, title: "Сумочка 5", price: 4000, currency: "р", image: "https://via.placeholder.com/150", description: "Описание." }
                                ]
                            },
                            {
                                name: "Серьги и кольца",
                                items: [
                                    {
                                        id: 'koltso-feyerverk',
                                        isInStock: true,
                                        title: "Кольцо «Фейерверг»",
                                        price: 2600,
                                        currency: "р",
                                        image: "https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Katalog/Колье «Геометрия Чувств»/Колье «Геометрия Чувств».jpg",
                                        video: "",
                                        media: [
                                            { type: 'photo', url: 'https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Katalog/Колье «Геометрия Чувств»/Колье «Геометрия Чувств».jpg' },
                                            { type: 'photo', url: 'https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Katalog/Колье «Геометрия Чувств»/Колье «Геометрия Чувств».jpg' },
                                            { type: 'video', url: 'https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Katalog/Колье «Геометрия Чувств»/Колье «Геометрия Чувств».mp4' },
                                            { type: 'photo', url: 'https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Katalog/Колье «Геометрия Чувств»/Колье «Геометрия Чувств».jpg' }
                                        ],
                                        description: `Это украшение я создала для тех, кто не ищет компромиссов между роскошью и дерзостью. 
                                — Кольцо «Фейерверг»: Натуральный прямоугольный жемчуг глубокого серого и цветного оттенков. Авторская работа Василисы.`
                                    },
                                    { id: 'koltso-2', isInStock: false, title: "Кольцо 2", price: 5000, currency: "р", image: "https://via.placeholder.com/150", description: "Описание кольца." },
                                    { id: 'koltso-3', isInStock: false, title: "Кольцо 3", price: 5000, currency: "р", image: "https://via.placeholder.com/150", description: "Описание кольца." },
                                    { id: 'koltso-4', isInStock: false, title: "Кольцо 4", price: 5000, currency: "р", image: "https://via.placeholder.com/150", description: "Описание кольца." },
                                    { id: 'koltso-5', isInStock: false, title: "Кольцо 5", price: 5000, currency: "р", image: "https://via.placeholder.com/150", description: "Описание кольца." }
                                ]
                            },
                            {
                                name: "Колье и подвески",
                                items: [
                                    {
                                        id: 'kolye-geometriya-chuvstv',
                                        isInStock: true,
                                        title: "Колье «Геометрия Чувств»",
                                        price: 12600,
                                        currency: "р",
                                        image: "https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Katalog/Колье «Геометрия Чувств»/Колье «Геометрия Чувств».jpg",
                                        video: "",
                                        media: [
                                            { type: 'photo', url: 'https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Katalog/Колье «Геометрия Чувств»/Колье «Геометрия Чувств».jpg' },
                                            { type: 'photo', url: 'https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Katalog/Колье «Геометрия Чувств»/Колье «Геометрия Чувств».jpg' },
                                            { type: 'video', url: 'https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Katalog/Колье «Геометрия Чувств»/Колье «Геометрия Чувств».mp4' },
                                            { type: 'photo', url: 'https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Katalog/Колье «Геометрия Чувств»/Колье «Геометрия Чувств».jpg' }
                                        ],
                                        description: `Это украшение я создала для тех, кто не ищет компромиссов между роскошью и дерзостью. Я взяла прямоугольный жемчуг — самую неклассическую его форму — и окрасила в глубокий, жемчужно-серый цвет. 
                                Я добавила цветные акценты, чтобы показать: вы не обязаны быть "идеальной". Вы можете быть разной, но всегда — безупречной.
                                Это колье создано для тех, кто любит дерзкую элегантность. Оно не про нежность. Оно про характер.
                                Вы можете надеть его со строгим пиджаком, чтобы сбить с толку, или с кожаной курткой, чтобы добавить роскоши. Оно — ваш стильный бунт, ваша тайная сила.
                                Позвольте себе этот современный Код Смелости.
                                — Колье «Геометрия Чувств»: Натуральный прямоугольный жемчуг глубокого серого и цветного оттенков. Авторская работа Василисы. — Хотите примерить смелость?`
                                    },
                                    { id: 'kolye-2', isInStock: false, title: "Колье 2", price: 5000, currency: "р", image: "https://via.placeholder.com/150", description: "Описание колье." },
                                    { id: 'kolye-3', isInStock: false, title: "Колье 3", price: 5000, currency: "р", image: "https://via.placeholder.com/150", description: "Описание колье." },
                                    { id: 'kolye-4', isInStock: false, title: "Колье 4", price: 5000, currency: "р", image: "https://via.placeholder.com/150", description: "Описание колье." },
                                    { id: 'kolye-5', isInStock: false, title: "Колье 5", price: 5000, currency: "р", image: "https://via.placeholder.com/150", description: "Описание колье." }
                                ]
                            },
                            {
                                name: "Броши и браслеты",
                                items: [
                                    {
                                        id: 'braslet-shkatulka-zhelaniy',
                                        isInStock: false,
                                        title: "Браслет «Шкатулка Желаний»",
                                        price: 5600,
                                        currency: "р",
                                        image: "https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Мини сумочка  «Шкатулка Желаний».jpg",
                                        video: "",
                                        media: [
                                            { type: 'photo', url: 'https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Мини сумочка  «Шкатулка Желаний».jpg' },
                                            { type: 'photo', url: 'https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Мини сумочка  «Шкатулка Желаний».jpg' },
                                            { type: 'video', url: 'https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Мини сумочка  «Шкатулка Желаний».mp4' },
                                            { type: 'photo', url: 'https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Мини сумочка  «Шкатулка Желаний».jpg' }
                                        ],
                                        description: `В мире, где личная магия часто остается незаметной, я создала открытый вызов.
                                Это аксессуар, который несет в себе ваш смысл.
                                Он говорит миру:
                                "Да, это моя магия. И она всегда при мне."
                                
                                Позвольте себе эту уникальность. — Браслет «Шкатулка Желаний»: Вышивка пайетками и бисером. Кристаллы и бусины Сваровски. Функциональный/нарядный аксессуар.`
                                    },
                                    { id: 'braslet-2', isInStock: false, title: "Браслет 2", price: 4000, currency: "р", image: "https://via.placeholder.com/150", description: "Описание." },
                                    { id: 'braslet-3', isInStock: false, title: "Браслет 3", price: 4000, currency: "р", image: "https://via.placeholder.com/150", description: "Описание." },
                                    { id: 'braslet-4', isInStock: false, title: "Браслет 4", price: 4000, currency: "р", image: "https://via.placeholder.com/150", description: "Описание." },
                                    { id: 'braslet-5', isInStock: false, title: "Браслет 5", price: 4000, currency: "р", image: "https://via.placeholder.com/150", description: "Описание." }
                                ]
                            },
                            {
                                name: "Для волос",
                                items: [
                                    {
                                        id: 'zakolka-shkatulka-zhelaniy',
                                        isInStock: false,
                                        title: "Заколка «Шкатулка Желаний»",
                                        price: 5600,
                                        currency: "р",
                                        image: "https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Мини сумочка  «Шкатулка Желаний».jpg",
                                        video: "",
                                        media: [
                                            { type: 'photo', url: 'https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Мини сумочка  «Шкатулка Желаний».jpg' },
                                            { type: 'photo', url: 'https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Мини сумочка  «Шкатулка Желаний».jpg' },
                                            { type: 'video', url: 'https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Мини сумочка  «Шкатулка Желаний».mp4' },
                                            { type: 'photo', url: 'https://raw.githubusercontent.com/znamenskiialeksei/presentation/main/Мини сумочка  «Шкатулка Желаний».jpg' }
                                        ],
                                        description: `Это аксессуар, который несет в себе ваш смысл.
                                Он говорит миру:
                                "Да, это моя магия. И она всегда при мне."
                                Позвольте себе эту уникальность. — Заколка «Шкатулка Желаний»: Вышивка пайетками и бисером. Кристаллы и бусины Сваровски. Функциональный/нарядный аксессуар.`
                                    },
                                    { id: 'zakolka-2', isInStock: false, title: "Заколка 2", price: 4000, currency: "р", image: "https://via.placeholder.com/150", description: "Описание." },
                                    { id: 'zakolka-3', isInStock: false, title: "Заколка 3", price: 4000, currency: "р", image: "https://via.placeholder.com/150", description: "Описание." },
                                    { id: 'zakolka-4', isInStock: false, title: "Заколка 4", price: 4000, currency: "р", image: "https://via.placeholder.com/150", description: "Описание." },
                                    { id: 'zakolka-5', isInStock: false, title: "Заколка 5", price: 4000, currency: "р", image: "https://via.placeholder.com/150", description: "Описание." }
                                ]
                            },
                            {
                                name: "Индивидуальный дизайн",
                                items: [
                                    { id: 'ind-eskiz', isInStock: false, title: "Эскиз", price: 1000, currency: "р", image: "https://via.placeholder.com/150", description: "Разработка эскиза." },
                                    { id: 'ind-podbor-kamney', isInStock: false, title: "Подбор камней", price: 0, currency: "р", image: "https://via.placeholder.com/150", description: "Помощь в выборе." },
                                    { id: 'ind-restavratsiya', isInStock: false, title: "Реставрация", price: 2000, currency: "р", image: "https://via.placeholder.com/150", description: "Восстановление украшений." },
                                    { id: 'ind-peredelka', isInStock: false, title: "Переделка", price: 3000, currency: "р", image: "https://via.placeholder.com/150", description: "Новая жизнь старых вещей." },
                                    { id: 'ind-srochnyy-zakaz', isInStock: false, title: "Срочный заказ", price: "30%", currency: "", image: "https://via.placeholder.com/150", description: "Наценка за срочность." }
                                ]
                            }
                        ]
                    },
                    // Генерация страницы 4 использует данные из configData
                    // ИСПРАВЛЕНИЕ: Заменяем IIFE на строковый маркер
                    text: '@@GENERATE_ORDER_CATALOG_FROM_CONFIG_DATA@@',
                    narrationEndTime: 0,
                },

                //==============================================================//
                //======================= СТРАНИЦА 5: КОНТАКТЫ И ФИДБЕК ========//
                //==============================================================//
                {
                    published: true,
                    collapsible: true,
                    collapsedOnLoad: true,
                    customHeight: 'auto',
                    text: `<h2>Связь и Обратная связь</h2>
            <p>Остались вопросы? Хотите заказать украшение или записаться на курс? Свяжитесь со мной удобным способом.</p>
            <p>Укажите ссылку на товар из каталога, который вас заинтересовал, в сообщении ниже.</p>
            
            <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-top: 20px;">
                <a href="https://t.me/Vasilisaznamenskaya" target="_blank" style="text-decoration: none; background: #0088cc; color: white; padding: 10px 20px; border-radius: 5px; display: flex; align-items: center; gap: 5px;">
                    Telegram Канал
                </a>
                <a href="https://youtube.com/@vasilisaluneville2024?si=x8dj95IxGk24YKgM" target="_blank" style="text-decoration: none; background: #FF0000; color: white; padding: 10px 20px; border-radius: 5px; display: flex; align-items: center; gap: 5px;">
                    YouTube Канал
                </a>
                <a href="https://wa.me/79213047892" target="_blank" style="text-decoration: none; background: #0088cc; color: white; padding: 10px 20px; border-radius: 5px; display: flex; align-items: center; gap: 5px;">
                    WhatsApp
                </a>
            </div>
            
            <hr>
            <p><strong>Форма обратной связи:</strong></p>
            <textarea placeholder="Вставьте название украшения или ваш вопрос..." style="width: 100%; height: 100px; padding: 10px; border-radius: 5px; border: 1px solid #ccc;"></textarea>
            <button style="background: #333; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-top: 10px; cursor: pointer;" onclick="alert('Спасибо за сообщение! Мы свяжемся с вами.')">Отправить</button>`,
                    narrationEndTime: 0,
                },
                //==============================================================//
                //================= СТРАНИЦА-ШАБЛОН (СКРЫТА) ===================//
                //==============================================================//
                {
                    // Эта страница не будет показана пользователям, так как published: false.
                    // Она служит как пример и шпаргалка по всем возможностям форматирования.
                    published: false,
                    collapsible: true,
                    collapsedOnLoad: true,
                    narrationEndTime: 0,
                    text: `
                <h2>Шаблон страницы: Все возможности</h2>
                <p>Эта страница - ваш конструктор. Здесь показано, как использовать все доступные элементы форматирования и встраивания медиа. <strong>Жирный текст</strong>, <em>курсив</em>, <code>моноширинный текст для кода</code>, <a href="#" onclick="event.preventDefault()">ссылки</a> и многое другое доступно с помощью стандартных HTML-тегов.</p>
                
                <hr> <h3>1. Встраивание одиночных изображений</h3>
                <p>Вы можете вставить изображение и управлять его размером и обтеканием текста. Вот пример изображения среднего размера, выровненного по центру (по умолчанию):</p>
                <img src="https://raw.githubusercontent.com/znamenskiialeksei/my-audiobook-foto/main/%D1%801.png" alt="Пример изображения" class="embedded-media size-medium">
                
                <p>
                    <img src="https://raw.githubusercontent.com/znamenskiialeksei/my-audiobook-foto/main/%D1%802.png" alt="Маленькое изображение слева" class="embedded-media size-small align-left">
                    А так выглядит текст, который <strong>обтекает маленькое изображение слева</strong>. Для этого к тегу <code>&lt;img&gt;</code> нужно добавить классы <code>embedded-media</code>, <code>size-small</code> и <code>align-left</code>. Это очень удобно для иллюстрации небольших деталей прямо по ходу повествования, не прерывая основной мысли. Текст будет продолжаться справа от картинки, пока не заполнит все свободное пространство по высоте.
                </p>
                <p>Этот новый параграф начнется уже после того, как закончится обтекание предыдущего изображения, благодаря специальному CSS-правилу.</p>

                <hr>
                
                <h3>2. Встраивание видео</h3>
                <p>Можно вставлять видео как по прямой ссылке на файл .mp4, так и через iframe с видеохостингов (YouTube, Vimeo, Google Drive).</p>
                
                <h4>Видео с прямой ссылкой (.mp4):</h4>
                <video controls src="https://archive.org/download/BigBuckBunny_124/Content/big_buck_bunny_720p_surround.mp4" class="embedded-media size-large"></video>
                
                <h4>Вертикальное видео (Reels/Shorts) с YouTube:</h4>
                <p>Для вертикальных видео используйте дополнительный класс <code>reels-style</code>.</p>
                <iframe src="https://www.youtube.com/embed/v8K4k2-fLdA" class="embedded-media reels-style" allowfullscreen></iframe>
                
                <h4>Видео с Google Drive (через iframe):</h4>
                <p>Можно вставлять видео через iframe с видеохостингов.</p>
                <iframe src="https://drive.google.com/file/d/11TDsKfDIg_GD27Lml0Pow-4fsUrIV3LO/preview" width="240" height="180" allow="autoplay"></iframe>
                
                <hr>

                <h3>3. Встраивание галереи (Inline-карусель)</h3>
                <p>Вы можете добавить галерею с горизонтальной прокруткой прямо в текст. Для этого создайте блок <code>&lt;div class="inline-carousel-container"&gt;</code> и поместите в него теги <code>&lt;img class="inline-carousel-img"&gt;</code>.</p>
                <div class="inline-carousel-container">
                    <img src="https://raw.githubusercontent.com/znamenskiialeksei/my-audiobook-foto/main/%D1%801.png" alt="Фото 1" class="inline-carousel-img">
                    <img src="https://raw.githubusercontent.com/znamenskiialeksei/my-audiobook-foto/main/%D1%802.png" alt="Фото 2" class="inline-carousel-img">
                    <img src="https://raw.githubusercontent.com/znamenskiialeksei/my-audiobook-foto/main/%D1%803.png" alt="Фото 3" class="inline-carousel-img">
                    <img src="https://raw.githubusercontent.com/znamenskiialeksei/my-audiobook-foto/main/%D1%804.png" alt="Фото 4" class="inline-carousel-img">
                    <img src="https://raw.githubusercontent.com/znamenskiialeksei/my-audiobook-foto/main/%D1%805.png" alt="Фото 5" class="inline-carousel-img">
                </div>

                <hr>

                <h3>4. Встраивание аудио</h3>
                <p>Вы можете добавить аудиоплеер прямо в текст. Используйте класс <code>embedded-audio</code>.</p>
                <audio controls src="https://raw.githubusercontent.com/znamenskiialeksei/my-audiobook/main/%D0%A2%D0%B5%D0%BA%D1%81%D1%82%20%D0%9F%D0%BB%D0%B0%D1%81%D1%82%D0%B8%D0%BB%D0%B8%D0%BD%D0%BE%D0%B2%D0%B0%D1%8F%20%D1%8F%D1%85%D1%82%D0%B0%20%D0%BC%D0%BD%D0%BE%D0%B3%D0%BE%D0%BB%D0%BE%D1%81%D1%8B%D0%B924.mp3" class="embedded-audio"></audio>
                <p>Это позволяет вставлять фоновую музыку, звуковые эффекты или дополнительные аудио-комментарии.</p>
                `,
                    extraMedia: [{
                        type: 'carousel',
                        buttonText: 'Модальная галерея',
                        headerText: 'Галерея в модальном окне',
                        images: [{
                            url: 'https://1drv.ms/i/c/2919ff56cb24dc70/IQTt0pbjcDOaQ4EzOYUnlLjFAcFIzWiG_6RGa8MxNqsnAE8?action=embedview',
                            caption: 'Фото 1',
                            width: 931,
                            height: 616
                        }, {
                            url: 'https://1drv.ms/i/c/2919ff56cb24dc70/IQSyu_NPfwz-Q7vkjqlgRWihAQq3NPmk8Zii_vvq84r6MCY?action=embedview',
                            caption: 'Фото 2',
                            width: 1155,
                            height: 707
                        }]
                    }, {
                        type: 'video',
                        buttonText: 'Модальное видео',
                        url: 'https://www.youtube.com/embed/Dp2g78eqw18',
                        headerText: 'Видео в модальном окне'
                    }, {
                        type: 'iframe',
                        buttonText: '360-тур (iframe)',
                        url: 'https://360.bavariayachts.com/2021/tours/index_en.html?nav_id=5491-135719',
                        headerText: '360° тур по яхте'
                    }, {
                        // Тип 'text' позволяет подгрузить текстовый файл по ссылке и показать в модальном окне.
                        type: 'text',
                        buttonText: 'Доп. текст',
                        url: 'https://raw.githubusercontent.com/znamenskiialeksei/marmarisyachting/main/README.md',
                        headerText: 'Дополнительная информация'
                    }]
                },
            ]
        };
        /*--CONFIG_END--*/
    </script>

    <script id="main-logic-script">
        /* Начало блока JavaScript */

        // =============================================================================
        // --- ГЕНЕРАТОР КАТАЛОГА (Ожидает функцию generateSmartCatalog из config.js) ---
        // =============================================================================
        // Примечание: Функция generateSmartCatalog должна быть определена в config.js.
        // Чтобы избежать ошибки 'generateSmartCatalog is not defined' при парсинге, 
        // мы определяем ее здесь, если она не была определена в config.js.
        if (typeof generateSmartCatalog === 'undefined') {
            window.CONFIG_STUB = { productCardButtons: { description: true, orderTelegram: true, orderWhatsapp: true } };
            // Заглушка, чтобы обеспечить работу парсинга, если config.js не вставлен
            function generateSmartCatalog(pageData) {
                console.error("Функция generateSmartCatalog не была загружена из config.js!");
                let html = `<h2>${pageData.header}</h2><p>${pageData.subHeader}</p>`;
                html += '<div style="color:red;">ОШИБКА ЗАГРУЗКИ КАТАЛОГА</div>';
                return html;
            }
        }

        // Определяем, является ли пользователь админом, ДО всех остальных операций
        const isAdmin = new URLSearchParams(window.location.search).get('admin') === 'true0901';

        // ====================================================================================================
        // --- НОВАЯ ГЛОБАЛЬНАЯ ФУНКЦИЯ: ПРОВЕРКА МЕТКИ ТОВАРА (ЗАДАЧА 2) ---
        // ====================================================================================================
        /**
         * Проверяет, должен ли товар отображаться на странице "В НАЛИЧИИ" на основе метки админа.
         * @param {string} itemId Уникальный ID товара.
         * @returns {boolean} true, если товар должен быть показан (метка установлена).
         */
        window.isItemInStock = function (itemId) {
            // 1. Получаем сохраненные статусы из localStorage
            const stockStatus = JSON.parse(localStorage.getItem('stockStatus') || '{}');
            // 2. Возвращаем статус для данного ID. По умолчанию - false.
            return !!stockStatus[itemId];
        }
        // ----------------------------------------------------------------------------------------------------


        document.addEventListener('DOMContentLoaded', function () {

            // ====================================================================================================
            // --- ГЛАВНЫЙ ОБЪЕКТ КОНФИГУРАЦИИ (CONFIG) ---
            // ====================================================================================================

            // --- ИЗМЕНЕНИЕ #1: Очистка кэша при выходе из режима администратора ---
            // Если пользователь НЕ админ, очищаем кастомную конфигурацию из localStorage,
            // чтобы он гарантированно увидел версию по умолчанию.
            if (!isAdmin && localStorage.getItem('customConfig')) {
                localStorage.removeItem('customConfig');
                console.log('Выход из режима администратора. Кастомная конфигурация очищена.');
            }

            let defaultConfigString;
            let CONFIG;

            // Извлекаем исходный код конфигурации прямо из HTML, чтобы сохранить комментарии
            try {
                const scriptTag = document.getElementById('config-script-tag');
                const scriptContent = scriptTag.innerHTML;
                const startIndex = scriptContent.indexOf('/*--CONFIG_START--*/');
                const endIndex = scriptContent.indexOf('/*--CONFIG_END--*/');
                if (startIndex === -1 || endIndex === -1) {
                    throw new Error("Маркеры /*--CONFIG_START--*/ или /*--CONFIG_END--*/ не найдены.");
                }

                const rawConfigBlock = scriptContent.substring(startIndex, endIndex);
                const objectStartIndex = rawConfigBlock.indexOf('{');
                const objectEndIndex = rawConfigBlock.lastIndexOf('}');
                defaultConfigString = rawConfigBlock.substring(objectStartIndex, objectEndIndex + 1);
            } catch (e) {
                console.error("Ошибка извлечения конфигурации из тега <script>:", e);
                // Используем пользовательское модальное окно вместо alert
                window.alert("Не удалось извлечь конфигурацию по умолчанию из HTML.");
                defaultConfigString = "{}"; // Аварийный вариант
            }

            // Определяем, какую конфигурацию использовать: из localStorage (для теста админа) или по умолчанию
            let effectiveConfigString = defaultConfigString;
            if (isAdmin && localStorage.getItem('customConfig')) {
                effectiveConfigString = localStorage.getItem('customConfig');
                console.log('Загружена кастомная конфигурация из localStorage.');
            }

            // Превращаем строку конфигурации в рабочий JavaScript-объект
            try {
                // Использование конструктора Function безопаснее, чем eval()
                CONFIG = new Function('generateSmartCatalog', 'return ' + effectiveConfigString)(generateSmartCatalog);
                // Сохраняем глобально для доступа из Stock Manager
                window.CONFIG = CONFIG;
            } catch (e) {
                console.error('КРИТИЧЕСКАЯ ОШИБКА ПАРСИНГА КОНФИГУРАЦИИ:', e);
                // Используем пользовательское модальное окно вместо alert
                window.alert('Ошибка в синтаксисе конфигурации. Приложение не может быть запущено. Будет загружена пустая конфигурация.');
                CONFIG = { pages: [], coverTexts: [], contactButtons: [], routeSelector: { routes: [] }, bottomMenuButtons: {}, productCardButtons: {} }; // Аварийный объект, чтобы избежать ошибок далее
            }

            // --- НОВЫЙ БЛОК: ПОСЛЕОБРАБОТКА ТЕКСТА (ИСПРАВЛЕНИЕ СИНТАКСИЧЕСКОЙ ОШИБКИ) ---
            if (CONFIG.pages) {
                // Страница 2: В НАЛИЧИИ (Индекс 1)
                if (CONFIG.pages[1] && CONFIG.pages[1].text === '@@GENERATE_STOCK_CATALOG_FROM_PAGE_4@@') {
                    // Страница 4 находится по индексу 3
                    const orderPage = CONFIG.pages[3];
                    if (orderPage && orderPage.configData) {
                        const stockData = {
                            header: "Украшения и аксессуары в наличии",
                            subHeader: "Здесь вы можете выбрать готовые изделия, помеченные как 'В НАЛИЧИИ' администратором. Нажмите на раздел, чтобы увидеть товары.",
                            categories: orderPage.configData.categories
                        };
                        // isStockPage: true включает фильтрацию по метке isInStock
                        CONFIG.pages[1].text = generateSmartCatalog(stockData, true);
                    } else if (isAdmin) {
                        adminErrors.push('Страница 2 (В НАЛИЧИИ) не смогла найти данные Страницы 4 (ПОД ЗАКАЗ). Проверьте структуру pages.');
                    }
                }

                // Страница 4: ПОД ЗАКАЗ (Индекс 3)
                if (CONFIG.pages[3] && CONFIG.pages[3].text === '@@GENERATE_ORDER_CATALOG_FROM_CONFIG_DATA@@') {
                    const orderPage = CONFIG.pages[3];
                    if (orderPage && orderPage.configData) {
                        // isStockPage: false, так как это страница "ПОД ЗАКАЗ" (показываем все)
                        CONFIG.pages[3].text = generateSmartCatalog(orderPage.configData, false);
                    } else if (isAdmin) {
                        adminErrors.push('Страница 4 (ПОД ЗАКАЗ) не имеет данных в configData. Проверьте структуру.');
                    }
                }
            }
            // ----------------------------------------------------------------------------------------------------


            // ====================================================================================================
            // --- ЛОГИКА СКРИПТА ---
            // ====================================================================================================

            const isMobile = window.innerWidth < 768;
            const isFeedMode = (isMobile && CONFIG.mobileFeedMode) || (!isMobile && CONFIG.feedModeForDesktop);
            if (isFeedMode) {
                document.body.classList.add('feed-mode');
            }

            const adminErrors = [];
            const publishedPages = CONFIG.pages ? CONFIG.pages.filter(p => p.published) : [];

            const coverView = document.getElementById('cover-view');
            const bookView = document.getElementById('book-view');
            const audioPlayer = document.getElementById('narrationAudio');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const nextBtn = document.getElementById('nextBtn');
            const prevBtn = document.getElementById('prevBtn');
            const pageIndicator = document.getElementById('pageIndicator');
            const conferenceBtn = document.getElementById('conferenceBtn');
            const bookingBtn = document.getElementById('bookingBtn');

            // НОВЫЕ КНОПКИ ДЛЯ ЗАДАЧИ 1
            const telegramBtn = document.getElementById('telegramBtn');
            const whatsappBtn = document.getElementById('whatsappBtn');
            const instagramBtn = document.getElementById('instagramBtn');

            let currentPage = 1;
            let isPlaying = false;
            let isCoverActive = true;
            let isNarratorModeActive = false;
            let tooltipTimeout = null;
            let jitsiApi = null;

            if (CONFIG.pulsingEffect && CONFIG.pulsingEffect.enabled) {
                const effect = CONFIG.pulsingEffect;
                const totalDuration = effect.fadeInDuration + effect.visibleDuration + effect.fadeOutDuration + effect.hiddenDuration;
                const fadeInEnd = (effect.fadeInDuration / totalDuration) * 100;
                const visibleEnd = ((effect.fadeInDuration + effect.visibleDuration) / totalDuration) * 100;
                const fadeOutEnd = ((effect.fadeInDuration + effect.visibleDuration + effect.fadeOutDuration) / totalDuration) * 100;
                const styleSheet = document.createElement("style");
                styleSheet.innerText = `@keyframes pulseAnimation { 0% { opacity: 0; } ${fadeInEnd}% { opacity: 1; } ${visibleEnd}% { opacity: 1; } ${fadeOutEnd}% { opacity: 0; } 100% { opacity: 0; } }`;
                document.head.appendChild(styleSheet);
                document.documentElement.style.setProperty('--pulse-total-duration', `${totalDuration}s`);
            }

            function createDropdownButton(config, parentElement) {
                if (!config || !config.visible) return;
                const menuBtn = document.createElement('button');
                menuBtn.className = 'cover-button route-selector-btn';
                menuBtn.style.top = config.top;
                menuBtn.style.left = config.left;
                menuBtn.innerHTML = config.icon;
                menuBtn.addEventListener('mouseenter', (e) => showTooltip(e.currentTarget, config.tooltip));
                menuBtn.addEventListener('mouseleave', hideTooltip);
                if ((CONFIG.pulsingEffect?.enabled && config.pulsing !== false) || config.pulsing === true) {
                    menuBtn.classList.add('pulsing');
                }
                const dropdown = document.createElement('div');
                dropdown.className = 'route-dropdown-menu';
                config.routes.forEach(route => {
                    const link = document.createElement('a');
                    link.textContent = route.name;
                    if (route.action === 'openBooking') {
                        link.href = '#';
                        link.onclick = (e) => {
                            e.preventDefault();
                            openBookingModal();
                            dropdown.classList.remove('visible');
                        };
                    } else {
                        link.href = route.url;
                        if (route.target) {
                            link.target = route.target;
                            link.rel = 'noopener noreferrer';
                        }
                    }
                    dropdown.appendChild(link);
                });
                parentElement.appendChild(menuBtn);
                document.body.appendChild(dropdown);
                menuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const rect = menuBtn.getBoundingClientRect();
                    const offset = 5;
                    const centerPullFactor = 0.25;
                    const buttonCenterX = rect.left + rect.width / 2;
                    const screenCenterX = window.innerWidth / 2;
                    const newLeft = buttonCenterX + (screenCenterX - buttonCenterX) * centerPullFactor;
                    if (rect.top < window.innerHeight / 2) {
                        dropdown.style.top = `${rect.bottom + offset}px`;
                        dropdown.style.transform = 'translate(-50%, 0)';
                        dropdown.style.transformOrigin = 'top center';
                    } else {
                        dropdown.style.top = `${rect.top - offset}px`;
                        dropdown.style.transform = 'translate(-50%, -100%)';
                        dropdown.style.transformOrigin = 'bottom center';
                    }
                    dropdown.style.left = `${newLeft}px`;
                    document.querySelectorAll('.route-dropdown-menu.visible').forEach(menu => {
                        if (menu !== dropdown) menu.classList.remove('visible');
                    });
                    dropdown.classList.toggle('visible');
                });
                document.addEventListener('click', (e) => {
                    if (!dropdown.contains(e.target) && !menuBtn.contains(e.target)) {
                        dropdown.classList.remove('visible');
                    }
                });
            }
            const tooltipBox = document.getElementById('tooltip-box');
            function showTooltip(element, text) {
                if (!text) return;
                clearTimeout(tooltipTimeout);
                tooltipBox.textContent = text;
                const rect = element.getBoundingClientRect();
                const offset = 5;
                const centerPullFactor = 0.25;
                const buttonCenterX = rect.left + rect.width / 2;
                const screenCenterX = window.innerWidth / 2;
                const newLeft = buttonCenterX + (screenCenterX - buttonCenterX) * centerPullFactor;
                if (rect.top < window.innerHeight / 2) {
                    tooltipBox.style.top = `${rect.bottom + offset}px`;
                    tooltipBox.style.transform = 'translate(-50%, 0)';
                } else {
                    tooltipBox.style.top = `${rect.top - offset}px`;
                    tooltipBox.style.transform = 'translate(-50%, -100%)';
                }
                tooltipBox.style.left = `${newLeft}px`;
                tooltipBox.classList.add('visible');
                if (isMobile) {
                    tooltipTimeout = setTimeout(hideTooltip, 2000);
                }
            }

            function hideTooltip() {
                clearTimeout(tooltipTimeout);
                tooltipBox.classList.remove('visible');
            }

            function setupCover() {
                document.querySelector('#main-title').textContent = CONFIG.mainTitle;
                if (CONFIG.audioUrl) audioPlayer.src = CONFIG.audioUrl;
                else if (isAdmin) adminErrors.push('Не указан URL для основного аудио');
                if (CONFIG.coverVideoUrl) {
                    const video = document.createElement('video');
                    video.id = 'cover-video';
                    video.src = CONFIG.coverVideoUrl;
                    video.autoplay = true;
                    video.loop = true;
                    video.muted = true;
                    video.playsInline = true;
                    video.style.objectFit = CONFIG.coverVideoFitMode || 'cover';
                    coverView.prepend(video);
                } else if (isAdmin) {
                    adminErrors.push('Не указан URL для видео на обложке');
                }
                CONFIG.coverTexts.forEach((item) => {
                    if (item.visible !== false) {
                        const textBox = document.createElement('div');
                        textBox.className = 'cover-text-box';
                        textBox.style.top = item.top;
                        textBox.style.left = item.left;
                        const textBg = document.createElement('span');
                        textBg.className = 'cover-text-bg';
                        textBg.textContent = item.text;
                        textBox.appendChild(textBg);
                        textBox.addEventListener('mouseenter', (e) => showTooltip(e.currentTarget, item.tooltip));
                        textBox.addEventListener('mouseleave', hideTooltip);
                        coverView.appendChild(textBox);
                    }
                });
                if (CONFIG.contactButtons) {
                    CONFIG.contactButtons.forEach(btnData => {
                        if (btnData.visible && btnData.url) {
                            const contactBtn = document.createElement('a');
                            contactBtn.href = btnData.url;
                            contactBtn.className = 'cover-button';
                            contactBtn.target = '_blank';
                            contactBtn.rel = 'noopener noreferrer';
                            contactBtn.style.top = btnData.top;
                            contactBtn.style.left = btnData.left;
                            contactBtn.innerHTML = btnData.icon;
                            contactBtn.addEventListener('mouseenter', (e) => showTooltip(e.currentTarget, btnData.tooltip));
                            contactBtn.addEventListener('mouseleave', hideTooltip);
                            if ((CONFIG.pulsingEffect?.enabled && btnData.pulsing !== false) || btnData.pulsing === true) {
                                contactBtn.classList.add('pulsing');
                            }
                            coverView.appendChild(contactBtn);
                        }
                    });
                }
                if (CONFIG.routeSelector) {
                    createDropdownButton(CONFIG.routeSelector, coverView);
                }
            }

            function setupBookPages() {
                const pageViewer = document.querySelector('.page-viewer');
                pageViewer.innerHTML = '';
                publishedPages.forEach((pageData, index) => {
                    const pageNum = index + 1;
                    const page = document.createElement('div');
                    page.className = 'page';
                    page.dataset.pageNumber = pageNum;
                    if (pageNum === 1) page.classList.add('active');
                    const buttonsContainer = document.createElement('div');
                    buttonsContainer.className = 'page-buttons-container';
                    const allMedia = [];
                    if (pageData.mainVideo && pageData.mainVideo.url) {
                        const mainVideoButtonConfig = {
                            ...pageData.mainVideo,
                            type: pageData.mainVideo.type || 'video',
                            buttonText: pageData.mainVideo.buttonText || 'Показать видео'
                        };
                        allMedia.push(mainVideoButtonConfig);
                    }
                    if (pageData.extraMedia) {
                        allMedia.push(...pageData.extraMedia);
                    }
                    allMedia.forEach((media) => {
                        const hasUrl = (media.type === 'carousel' && media.images && media.images.length > 0) || (media.url && media.url.trim() !== '') || (media.type === 'blokiframe' && media.iframeCode && media.iframeCode.trim() !== '');
                        if (hasUrl) {
                            const btn = document.createElement('button');
                            const btnClass = (media.type === 'iframe' || media.type === 'blokiframe') ? 'iframe-btn' : `${media.type}-btn`;
                            btn.className = `page-btn ${btnClass}`;
                            btn.textContent = media.buttonText;
                            if (media.buttonColor) btn.style.backgroundColor = media.buttonColor;
                            if (media.buttonTextColor) btn.style.color = media.buttonTextColor;
                            btn.onclick = () => openMediaModal(media);
                            buttonsContainer.appendChild(btn);
                        } else if (isAdmin) {
                            const errorMsg = `Стр. ${pageNum}, кнопка "${media.buttonText}": URL или данные отсутствуют`;
                            adminErrors.push(errorMsg);
                            const errorBtn = document.createElement('button');
                            errorBtn.className = 'page-btn admin-error-btn';
                            errorBtn.textContent = 'ОШИБКА URL';
                            errorBtn.title = errorMsg;
                            buttonsContainer.appendChild(errorBtn);
                        }
                    });
                    const textContent = document.createElement('p');
                    textContent.innerHTML = pageData.text || '';

                    if (isFeedMode && pageData.collapsible) {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = pageData.text;
                        const h2 = tempDiv.querySelector('h2');
                        const title = h2 ? h2.innerHTML : 'Развернуть';
                        if (h2) h2.remove();
                        textContent.innerHTML = tempDiv.innerHTML;
                        const details = document.createElement('details');
                        details.open = !pageData.collapsedOnLoad;
                        if (pageData.customHeight && pageData.customHeight !== 'auto') {
                            page.style.height = details.open ? pageData.customHeight : 'auto';
                        }
                        details.addEventListener('toggle', () => {
                            if (pageData.customHeight && pageData.customHeight !== 'auto') {
                                page.style.height = details.open ? pageData.customHeight : 'auto';
                            }
                            if (details.open) {
                                const pageNumToSync = parseInt(page.dataset.pageNumber, 10);
                                currentPage = pageNumToSync;
                                const wasPlaying = isPlaying;
                                audioPlayer.currentTime = getPageStartTime(pageNumToSync);
                                if (wasPlaying) {
                                    audioPlayer.play();
                                }
                            }
                        });
                        const summary = document.createElement('summary');
                        summary.innerHTML = title;
                        details.appendChild(summary);
                        details.appendChild(buttonsContainer);
                        details.appendChild(textContent);
                        page.appendChild(details);
                    } else {
                        if (pageData.customHeight) {
                            page.style.height = pageData.customHeight;
                        }
                        page.appendChild(buttonsContainer);
                        page.appendChild(textContent);
                    }
                    pageViewer.appendChild(page);
                    if (pageData.customDropdowns && Array.isArray(pageData.customDropdowns)) {
                        pageData.customDropdowns.forEach(dropdownConfig => {
                            createDropdownButton(dropdownConfig, page);
                        });
                    }
                });
            }

            // --- ОБНОВЛЕННАЯ ФУНКЦИЯ ДЛЯ УПРАВЛЕНИЯ НИЖНИМИ КНОПКАМИ (ЗАДАЧА 1) ---
            function setupBottomMenuButtons() {
                const buttons = CONFIG.bottomMenuButtons || {};

                // Переключение видимости кнопок
                document.getElementById('prevBtnWrapper').style.display = buttons.prev === false ? 'none' : 'flex';
                document.getElementById('playPauseBtnWrapper').style.display = buttons.playPause === false ? 'none' : 'flex';
                document.getElementById('nextBtnWrapper').style.display = buttons.next === false ? 'none' : 'flex';
                document.getElementById('bookingBtnWrapper').style.display = buttons.booking === false ? 'none' : 'flex';
                document.getElementById('conferenceBtnWrapper').style.display = buttons.conference === false ? 'none' : 'flex';
                document.getElementById('pageIndicator').style.display = buttons.pageIndicator === false ? 'none' : 'flex';

                // НОВЫЕ КНОПКИ ДЛЯ ЗАДАЧИ 1
                document.getElementById('telegramBtnWrapper').style.display = buttons.telegram === false ? 'none' : 'flex';
                document.getElementById('whatsappBtnWrapper').style.display = buttons.whatsapp === false ? 'none' : 'flex';
                document.getElementById('instagramBtnWrapper').style.display = buttons.instagram === false ? 'none' : 'flex';
            }
            // ------------------------------------------------------------------------

            function updateAdminPanel() {
                if (isAdmin && adminErrors.length > 0) {
                    let panel = document.getElementById('admin-panel');
                    if (!panel) {
                        panel = document.createElement('div');
                        panel.id = 'admin-panel';
                        document.body.appendChild(panel);
                    }
                    let errorList = '<h4>Обнаружены ошибки конфигурации:</h4><ul>';
                    adminErrors.forEach(err => {
                        errorList += `<li>${err}</li>`;
                    });
                    errorList += '</ul>';
                    panel.innerHTML = errorList;
                }
            }

            const mediaModal = document.getElementById('mediaModal');
            const modalPhoto = document.getElementById('modalPhoto');
            const modalVideo = document.getElementById('modalVideo');
            const modalAudio = document.getElementById('modalAudio');
            const modalText = document.getElementById('modalText');
            const modalCarousel = document.getElementById('modalCarousel');
            const modalIframe = document.getElementById('modalIframe');
            const carouselPrevBtn = modalCarousel.querySelector('.prev');
            const carouselNextBtn = modalCarousel.querySelector('.next');
            let currentCarouselImages = [];
            let currentCarouselIndex = 0;
            function openConferenceModal() {
                if (jitsiApi) return;
                // --- БЛОК УВЕДОМЛЕНИЯ ---
                if (CONFIG.notificationScriptUrl && CONFIG.notificationScriptUrl.startsWith('https')) {
                    const payload = {
                        siteUrl: window.location.href,
                        roomName: CONFIG.videoConference.roomName || 'Unknown Room'
                    };
                    fetch(CONFIG.notificationScriptUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(payload)
                    }).catch(error => console.error('Ошибка отправки уведомления:', error));
                }
                // --- КОНЕЦ БЛОКА УВЕДОМЛЕНИЯ ---

                const jitsiContainer = document.getElementById('jitsi-container');
                [modalPhoto, modalVideo, modalAudio, modalText, modalCarousel, modalIframe].forEach(el => el.style.display = 'none');
                jitsiContainer.style.display = 'block';

                mediaModal.querySelector('.modal-header').textContent = 'Присоединение к видеоконференции...';
                mediaModal.querySelector('.modal-footer').textContent = 'Вы можете включить/выключить камеру и микрофон внизу экрана.';
                mediaModal.style.display = 'flex';
                setTimeout(() => {
                    const options = {
                        roomName: CONFIG.videoConference.roomName || 'MarmarisYachtVasilisaTestRoom',
                        parentNode: jitsiContainer,
                        configOverwrite: {
                            startWithVideoMuted: true,
                            startWithAudioMuted: false,
                            prejoinPageEnabled: true
                        },
                        interfaceConfigOverwrite: {
                            TOOLBAR_BUTTONS: [
                                'microphone', 'camera', 'desktop', 'hangup', 'chat', 'raisehand', 'tileview'
                            ],
                        }
                    };

                    try {
                        jitsiApi = new JitsiMeetExternalAPI("meet.jit.si", options);
                        jitsiApi.addEventListener('readyToClose', () => {
                            closeModal(mediaModal);
                        });
                    } catch (error) {
                        console.error("Не удалось запустить Jitsi API:", error);
                        jitsiContainer.innerHTML = "Ошибка при запуске видеоконференции. Попробуйте обновить страницу.";
                    }
                }, 100);
            }

            function openMediaModal(media) {
                [modalPhoto, modalVideo, modalAudio, modalText, modalCarousel, modalIframe].forEach(el => {
                    el.style.display = 'none';
                    if (el.tagName === 'VIDEO' || el.tagName === 'AUDIO') {
                        el.src = '';
                        el.pause();
                    } else if (el.tagName === 'IMG' || el.tagName === 'IFRAME') {
                        el.src = 'about:blank';
                    }
                });
                mediaModal.querySelector('.modal-header').textContent = media.headerText || '';
                mediaModal.querySelector('.modal-footer').textContent = media.footerText || '';

                if (media.type === 'carousel' && media.images && media.images.length > 0) {
                    currentCarouselImages = media.images;
                    currentCarouselIndex = 0;

                    function showCarouselSlide(index) {
                        const wrapper = document.getElementById('carouselIframeWrapper');
                        const iframe = document.getElementById('carouselIframe');
                        const slideData = currentCarouselImages[index];
                        if (!slideData || !slideData.url || !slideData.width || !slideData.height) {
                            iframe.src = 'about:blank';
                            return;
                        }
                        const containerWidth = wrapper.clientWidth;
                        const containerHeight = wrapper.clientHeight;
                        iframe.width = slideData.width;
                        iframe.height = slideData.height;
                        const scaleX = containerWidth / slideData.width;
                        const scaleY = containerHeight / slideData.height;
                        const scale = Math.min(scaleX, scaleY);
                        iframe.style.transform = `scale(${scale})`;
                        iframe.src = slideData.url;
                        mediaModal.querySelector('.modal-footer').textContent = slideData.caption || '';
                        carouselPrevBtn.style.visibility = (index === 0) ? 'hidden' : 'visible';
                        carouselNextBtn.style.visibility = (index === currentCarouselImages.length - 1) ? 'hidden' : 'visible';
                    }
                    carouselPrevBtn.onclick = () => {
                        if (currentCarouselIndex > 0) {
                            currentCarouselIndex--;
                            showCarouselSlide(currentCarouselIndex);
                        }
                    };
                    carouselNextBtn.onclick = () => {
                        if (currentCarouselIndex < currentCarouselImages.length - 1) {
                            currentCarouselIndex++;
                            showCarouselSlide(currentCarouselIndex);
                        }
                    };
                    modalCarousel.style.display = 'flex';
                    setTimeout(() => {
                        showCarouselSlide(0);
                    }, 50);
                } else {
                    let contentElement;
                    if (media.type === 'iframe') {
                        if (media.width && media.height) {
                            modalIframe.style.aspectRatio = `${media.width} / ${media.height}`;
                            modalIframe.style.width = 'auto';
                            modalIframe.style.height = 'auto';
                        } else {
                            modalIframe.style.aspectRatio = '16 / 9';
                            modalIframe.style.width = '90%';
                            modalIframe.style.height = '80%';
                        }
                        modalIframe.src = media.url;
                        modalIframe.style.display = 'block';
                    } else if (media.type === 'blokiframe') {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = media.iframeCode.trim();
                        const tempIframe = tempDiv.firstChild;
                        if (tempIframe && tempIframe.tagName === 'IFRAME' && tempIframe.src) {
                            modalIframe.style.aspectRatio = '16 / 9';
                            modalIframe.style.width = '90%';
                            modalIframe.style.height = 'auto';
                            modalIframe.src = tempIframe.src;
                            modalIframe.style.display = 'block';
                        } else if (isAdmin) {
                            // Используем пользовательское модальное окно вместо alert
                            window.alert('Ошибка в коде для blokiframe: ' + media.iframeCode);
                        }
                    } else if (media.type === 'photo') {
                        contentElement = modalPhoto;
                    } else if (media.type === 'video') {
                        if (media.url.includes('youtu.be') || media.url.includes('youtube.com')) {
                            const videoId = media.url.split('v=')[1] || media.url.split('/').pop().split('?')[0];
                            const embedUrl = `https://www.youtube.com/embed/${videoId}`;
                            modalIframe.style.aspectRatio = '16 / 9';
                            modalIframe.style.width = '90%';
                            modalIframe.style.height = 'auto';
                            modalIframe.src = embedUrl;
                            modalIframe.style.display = 'block';
                        } else {
                            contentElement = modalVideo;
                        }
                    } else if (media.type === 'audio') {
                        contentElement = modalAudio;
                    } else if (media.type === 'text') {
                        contentElement = modalText;
                    }
                    if (contentElement) {
                        if (media.type === 'text') {
                            contentElement.innerHTML = '<em>Загрузка...</em>';
                            // Если передан HTML контент напрямую (наш случай для товаров)
                            if (media.htmlContent) {
                                contentElement.innerHTML = media.htmlContent;
                            } else {
                                fetch(media.url).then(res => res.text()).then(text => contentElement.innerHTML = text).catch(err => contentElement.innerHTML = '<strong>Ошибка загрузки.</strong>');
                            }
                        } else {
                            contentElement.src = media.url;
                        }
                        contentElement.style.display = 'block';
                        if ((media.type === 'video' || media.type === 'audio')) {
                            contentElement.play();
                        }
                    }
                }
                mediaModal.style.display = 'flex';
            }
            const bookingModal = document.getElementById('bookingModal');
            const bookingFrame = document.getElementById('bookingFrame');
            function closeModal(modal) {
                modal.style.display = 'none';
                if (modal.id === 'mediaModal') {
                    if (jitsiApi) {
                        jitsiApi.dispose();
                        jitsiApi = null;
                    }
                    const jitsiContainer = document.getElementById('jitsi-container');
                    if (jitsiContainer) {
                        jitsiContainer.style.display = 'none';
                        jitsiContainer.innerHTML = '';
                    }
                    [modalPhoto, modalVideo, modalAudio, modalText, modalCarousel, modalIframe].forEach(el => {
                        el.style.display = 'none';
                        if (el.tagName === 'VIDEO' || el.tagName === 'AUDIO') {
                            el.pause();
                            el.src = '';
                        } else if (el.tagName === 'IMG' || el.tagName === 'IFRAME') {
                            el.src = 'about:blank';
                        }
                    });
                }
                if (modal.id === 'bookingModal') {
                    bookingFrame.src = '';
                }
            }
            mediaModal.querySelector('.modal-close').onclick = () => closeModal(mediaModal);
            bookingModal.querySelector('.modal-close').onclick = () => closeModal(bookingModal);

            function openBookingModal() {
                if (!CONFIG.bookingUrl && isAdmin) {
                    adminErrors.push('URL формы бронирования не указан в CONFIG');
                    updateAdminPanel();
                    return;
                }
                document.getElementById('iframe-wrapper').style.height = '90vh';
                bookingFrame.src = CONFIG.bookingUrl;
                bookingModal.style.display = 'flex';
            }
            document.getElementById('bookingBtn').onclick = openBookingModal;
            window.addEventListener('message', function (event) {
                if (event.data && event.data.type === 'formHeight') {
                    const wrapper = document.getElementById('iframe-wrapper');
                    const padding = parseInt(getComputedStyle(wrapper).paddingTop) * 2;
                    wrapper.style.height = (event.data.height + padding + 5) + 'px';
                }
            });
            function showPage(pageNumber) {
                if (pageNumber < 1 || pageNumber > publishedPages.length) return;
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.querySelector(`.page[data-page-number="${pageNumber}"]`).classList.add('active');
                currentPage = pageNumber;
                updateButtonsAndIndicator();
            }

            function updateButtonsAndIndicator() {
                if (!isFeedMode) {
                    // Управление видимостью кнопок навигации в режиме "Книги"
                    const prevWrapper = document.getElementById('prevBtnWrapper');
                    const nextWrapper = document.getElementById('nextBtnWrapper');
                    const bookingWrapper = document.getElementById('bookingBtnWrapper');

                    if (prevWrapper) prevWrapper.style.display = (CONFIG.bottomMenuButtons?.prev === false || isCoverActive) ? 'none' : 'flex';
                    if (nextWrapper) nextWrapper.style.display = CONFIG.bottomMenuButtons?.next === false ? 'none' : 'flex';
                    if (bookingWrapper) bookingWrapper.style.display = CONFIG.bottomMenuButtons?.booking === false ? 'none' : 'flex';

                    // Индикатор страниц
                    pageIndicator.textContent = isCoverActive ? `0 / ${publishedPages.length}` : `${currentPage} / ${publishedPages.length}`;

                } else {
                    // В режиме ленты скрываем навигационные кнопки
                    document.getElementById('prevBtnWrapper').style.display = 'none';
                    document.getElementById('nextBtnWrapper').style.display = 'none';
                    if (document.getElementById('pageIndicator')) document.getElementById('pageIndicator').style.display = 'none';
                }
            }

            function getPageStartTime(pageNumber) {
                if (pageNumber <= 1) return 0;
                return publishedPages[pageNumber - 2].narrationEndTime;
            }

            function scrollToPage(pageNum) {
                const targetPage = document.querySelector(`.page[data-page-number="${pageNum}"]`);
                if (targetPage) {
                    targetPage.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            }

            playPauseBtn.addEventListener('click', () => {
                if (isFeedMode && isCoverActive) {
                    isNarratorModeActive = true;
                    isCoverActive = false;
                    scrollToPage(1);
                    const firstPage = document.querySelector('.page[data-page-number="1"] details');
                    if (firstPage && !firstPage.open) {
                        firstPage.open = true;
                    }
                    audioPlayer.currentTime = 0;
                    audioPlayer.play();
                } else if (!isFeedMode && isCoverActive) {
                    coverView.style.display = 'none';
                    bookView.style.display = 'flex';
                    isCoverActive = false;
                    showPage(1);
                    audioPlayer.currentTime = 0;
                    audioPlayer.play();
                } else {
                    if (isPlaying) {
                        audioPlayer.pause();
                        if (isFeedMode) isNarratorModeActive = false;
                    } else {
                        audioPlayer.play();
                        if (isFeedMode) isNarratorModeActive = true;
                    }
                }
            });
            audioPlayer.onplaying = () => {
                isPlaying = true;
                playPauseBtn.textContent = '❚❚';
            };
            audioPlayer.onpause = () => {
                isPlaying = false;
                playPauseBtn.textContent = '▶';
            };
            audioPlayer.onended = () => {
                isPlaying = false;
                playPauseBtn.textContent = '▶';
                if (isFeedMode) {
                    isNarratorModeActive = false;
                    const lastPage = document.querySelector(`.page[data-page-number="${currentPage}"] details`);
                    if (lastPage) lastPage.open = false;
                    document.getElementById('cover-view').scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                    isCoverActive = true;
                    currentPage = 1;
                } else {
                    showPage(1);
                }
            };
            nextBtn.addEventListener('click', () => {
                if (!isFeedMode) {
                    if (isCoverActive) {
                        coverView.style.display = 'none';
                        bookView.style.display = 'flex';
                        isCoverActive = false;
                        showPage(1);
                    } else if (currentPage < publishedPages.length) {
                        const nextPage = currentPage + 1;
                        showPage(nextPage);
                        audioPlayer.currentTime = getPageStartTime(nextPage);
                    }
                }
            });
            prevBtn.addEventListener('click', () => {
                if (!isFeedMode) {
                    if (isCoverActive) return;
                    if (currentPage > 1) {
                        const prevPage = currentPage - 1;
                        showPage(prevPage);
                        audioPlayer.currentTime = getPageStartTime(prevPage);
                    } else {
                        bookView.style.display = 'none';
                        coverView.style.display = 'flex';
                        isCoverActive = true;
                        audioPlayer.pause();
                        updateButtonsAndIndicator();
                    }
                }
            });
            audioPlayer.addEventListener('timeupdate', () => {
                if (isCoverActive) return;
                const isAutoPilot = (isFeedMode && isNarratorModeActive) || (!isFeedMode && CONFIG.isContinuousPlayback);
                if (isAutoPilot && isPlaying) {
                    const currentTime = audioPlayer.currentTime;
                    const targetPageData = publishedPages.find((p, index) => {
                        const startTime = getPageStartTime(index + 1);
                        return currentTime >= startTime && currentTime < p.narrationEndTime;
                    });
                    if (!targetPageData) return;
                    const newPageNum = publishedPages.indexOf(targetPageData) + 1;

                    if (isFeedMode) {
                        if (newPageNum !== currentPage) {
                            const prevPageDetails = document.querySelector(`.page[data-page-number="${currentPage}"] details`);
                            if (prevPageDetails && prevPageDetails.open) prevPageDetails.open = false;
                            const newPageDetails = document.querySelector(`.page[data-page-number="${newPageNum}"] details`);
                            if (newPageDetails && !newPageDetails.open) newPageDetails.open = true;
                            scrollToPage(newPageNum);
                            currentPage = newPageNum;
                        }
                    } else {
                        if (newPageNum !== currentPage) {
                            showPage(newPageNum);
                        }
                    }
                }
            });

            // ====================================================================================================
            // --- НОВАЯ ЛОГИКА: МЕНЕДЖЕР ЗАПАСОВ (ADMIN STOCK MANAGER) (ЗАДАЧА 3) ---
            // ====================================================================================================
            class AdminStockManager {
                constructor(config) {
                    // Получаем данные только со страницы "ПОД ЗАКАЗ" (которая должна быть pages[3])
                    // ИСПОЛЬЗУЕМ window.CONFIG, который уже был инициализирован
                    this.catalogData = window.CONFIG.pages[3]?.configData?.categories || [];
                    this.stockStatus = JSON.parse(localStorage.getItem('stockStatus') || '{}');
                    this.modal = document.getElementById('stock-manager-modal');
                    this.listContainer = document.getElementById('stock-manager-list');
                    // ИСПРАВЛЕНИЕ: Получаем кнопку закрытия по новому ID внутри модального окна
                    this.closeBtn = document.getElementById('stock-manager-modal')?.querySelector('.modal-close');


                    this.setupUI();
                }

                setupUI() {
                    if (!isAdmin) return;
                    // ИСПРАВЛЕНО: Кнопка уже существует в HTML с id="stock-manager-btn", просто делаем ее видимой
                    const managerBtn = document.getElementById('stock-manager-btn');
                    if (managerBtn) {
                        managerBtn.style.display = 'block';
                    }

                    // Создание модального окна, если его еще нет (уже есть в HTML, но без содержимого)
                    if (this.modal && !this.modal.querySelector('.stock-manager-modal-content')) {
                        this.modal.innerHTML = `
                    <div class="stock-manager-modal-content">
                        <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px;">
                            <h3>Управление наличием товаров</h3>
                            <span class="modal-close">&times;</span>
                        </div>
                        <p style="color:#666; font-size:0.9em;">Отметьте товары из каталога "Под Заказ", которые должны отображаться в каталоге "В Наличии".</p>
                        <div id="stock-manager-list" class="stock-manager-list"></div>
                    </div>
                `;
                        // Обновляем ссылки на элементы после вставки HTML
                        this.listContainer = document.getElementById('stock-manager-list');
                        this.closeBtn = this.modal.querySelector('.modal-close');
                    }

                    if (managerBtn) managerBtn.onclick = () => this.openModal();
                    if (this.closeBtn) this.closeBtn.onclick = () => this.closeModal();
                }

                openModal() {
                    this.renderList();
                    this.modal.style.display = 'flex';
                }

                closeModal() {
                    this.modal.style.display = 'none';
                }

                renderList() {
                    this.listContainer.innerHTML = '';
                    let listHtml = '';

                    this.catalogData.forEach(category => {
                        // Исключаем категории, где все товары не имеют ID (на всякий случай, если структура нарушена)
                        if (category.items.filter(item => item.id).length === 0) return;

                        listHtml += `<details class="sub-page-details" open><summary style="background:#f0f0f0;">${category.name}</summary><div style="padding: 0 10px;">`;

                        category.items.forEach(item => {
                            if (!item.id) {
                                // Товары без ID пропускаем, чтобы не ломать логику
                                listHtml += `<div style="color:red; font-size:0.8em;">Ошибка: У товара "${item.title}" отсутствует ID.</div>`;
                                return;
                            }

                            // ВАЖНО: При первой загрузке берем статус из CONFIG. При работе админа берем из localStorage
                            const isChecked = this.stockStatus[item.id] !== undefined
                                ? !!this.stockStatus[item.id]
                                : item.isInStock;

                            // Обновляем localStorage при первой загрузке, чтобы синхронизировать с config
                            this.stockStatus[item.id] = isChecked;


                            listHtml += `
                        <div class="stock-item" data-item-id="${item.id}">
                            <div class="stock-item-info">
                                <img src="${item.image || 'https://via.placeholder.com/50'}" class="stock-item-image" alt="${item.title}">
                                <span class="stock-item-title">${item.title}</span>
                            </div>
                            <label class="stock-checkbox-container">
                                В Наличии
                                <input type="checkbox" data-id="${item.id}" ${isChecked ? 'checked' : ''} onchange="window.stockManager.toggleStock(this)">
                                <span class="checkmark"></span>
                            </label>
                        </div>
                    `;
                        });

                        listHtml += '</div></details>';
                    });

                    this.listContainer.innerHTML = listHtml;
                    // Сохраняем актуальный stockStatus в localStorage после рендеринга (включая синхронизацию с config)
                    localStorage.setItem('stockStatus', JSON.stringify(this.stockStatus));
                }

                // --- НОВЫЙ МЕТОД: Отображение модального окна с инструкцией ---
                showCopyInstructionsModal(htmlContent, codeToCopy) {
                    if (!document.body.contains(this.modal)) return;

                    // Создаем временный контейнер для инструкции, чтобы не трогать основной список
                    let instructionModal = document.getElementById('stock-instruction-modal');
                    if (!instructionModal) {
                        instructionModal = document.createElement('div');
                        instructionModal.id = 'stock-instruction-modal';
                        instructionModal.className = 'modal';
                        instructionModal.style.zIndex = '10003';
                        instructionModal.innerHTML = `
                               <div class="stock-manager-modal-content" style="max-width: 500px; padding: 25px;">
                                   <div id="instruction-content"></div>
                                   <div style="text-align: right; margin-top: 15px;">
                                       <button class="btn-secondary" onclick="document.getElementById('stock-instruction-modal').style.display='none';">Закрыть</button>
                                   </div>
                               </div>
                           `;
                        document.body.appendChild(instructionModal);
                        // Кнопка закрытия не нужна, так как модальное окно закрывается вручную
                    }

                    instructionModal.querySelector('#instruction-content').innerHTML = htmlContent;
                    instructionModal.style.display = 'flex';

                    // Добавляем обработчик копирования
                    const copyBtn = instructionModal.querySelector('#copyStockCodeBtn');
                    if (copyBtn) {
                        copyBtn.onclick = () => {
                            if (codeToCopy) {
                                navigator.clipboard.writeText(codeToCopy).then(() => {
                                    copyBtn.textContent = '✅ Код скопирован!';
                                    setTimeout(() => {
                                        copyBtn.textContent = '📋 Копировать код для CONFIG';
                                    }, 2000);
                                }).catch(err => {
                                    alert('Ошибка копирования! См. консоль F12.');
                                    console.error('Ошибка копирования в буфер обмена:', err);
                                });
                            }
                        };
                    }
                } // Конец showCopyInstructionsModal
                // -------------------------------------------------------------


                toggleStock(checkboxElement) {
                    const itemId = checkboxElement.dataset.id;
                    const isChecked = checkboxElement.checked;
                    let newCatalogCode = '';

                    this.stockStatus[itemId] = isChecked;

                    // 1. Обновляем localStorage (для локального тестирования)
                    localStorage.setItem('stockStatus', JSON.stringify(this.stockStatus));

                    // --- МОДИФИЦИРОВАННЫЙ БЛОК: ГЕНЕРАЦИЯ ГОТОВОГО КОДА ---
                    // Получаем оригинальный объект конфигурации (Страница 4)
                    const orderPage = window.CONFIG.pages[3];
                    if (orderPage && orderPage.configData && orderPage.configData.categories) {
                        // Создаем глубокую копию, чтобы не менять рабочий CONFIG
                        const newConfigData = JSON.parse(JSON.stringify(orderPage.configData));

                        // Обновляем метку isInStock в скопированном объекте
                        newConfigData.categories.forEach(cat => {
                            cat.items.forEach(item => {
                                if (item.id === itemId) {
                                    // Обновляем метку isInStock в генерируемом коде
                                    item.isInStock = isChecked;
                                }
                            });
                        });

                        // Генерируем новый, готовый к вставке код (с форматированием)
                        // Используем 8 пробелов для отступа для лучшей читаемости вложенного объекта
                        newCatalogCode = JSON.stringify(newConfigData, null, 8);

                        // Сохраняем код в LocalStorage для кнопки "Копировать код для CONFIG"
                        localStorage.setItem('GeneratedStockConfigData', newCatalogCode);

                        console.log(`Товар ID: ${itemId}, Статус наличия: ${isChecked ? 'В НАЛИЧИИ' : 'ПОД ЗАКАЗ'}`);
                        console.log('НОВЫЙ КОД КАТАЛОГА СГЕНЕРИРОВАН И СОХРАНЕН В БУФЕРЕ КОНФИГУРАЦИИ!');
                        // console.log(newCatalogCode); // Выводим в консоль для F12
                    }
                    // -------------------------------------------------------------

                    // Обновляем UI списка товаров, чтобы чекбокс сразу отразил состояние
                    this.renderList();

                    // 2. Показываем админу инструкцию
                    const resultText = isChecked
                        ? `Товар "**${itemId}**" теперь помечен как **В НАЛИЧИИ**.`
                        : `Товар "**${itemId}**" теперь помечен как **ПОД ЗАКАЗ** (скрыт на Странице 2).`;

                    const instructionsHtml = `
                        <p>${resultText}</p>
                        <p style="font-weight: bold; color: #dc3545;">🚨 ВАЖНО: Изменение применилось только в вашем браузере!</p>
                        <h4>ШАГ 1: Скопируйте новый код</h4>
                        <p>Нажмите кнопку ниже. Новый код для поля <code>configData</code> Страницы 4 был автоматически сгенерирован.</p>
                        <button id="copyStockCodeBtn" class="btn-success" style="width:100%; margin-bottom: 10px;">
                            📋 Копировать код для CONFIG
                        </button>
                        <p style="font-size:0.9em; color:#007bff;">(Код был сохранен в буфере обмена)</p>
                        
                        <h4>ШАГ 2: Вставьте в основной файл</h4>
                        <ol>
                            <li>Закройте это окно и **Управление Товарами**.</li>
                            <li>Откройте **Редактор Конфигурации** (⚙️).</li>
                            <li>Найдите **Страницу 4** в коде.</li>
                            <li>Замените **всё содержимое** объекта <code>configData: { ... }</code> на скопированный код.</li>
                            <li>Нажмите **Сохранить и Перезагрузить** для теста.</li>
                        </ol>
                    `;

                    // Открываем модальное окно с инструкцией (для админа)
                    this.showCopyInstructionsModal(instructionsHtml, newCatalogCode);

                } // Конец toggleStock
            }
            // Делаем экземпляр доступным глобально, чтобы он мог обрабатывать события onchange
            window.stockManager = new AdminStockManager(CONFIG);
            // ----------------------------------------------------------------------------------------------------


            // --- УЛУЧШЕННАЯ ЛОГИКА КОНСТРУКТОРА ДЛЯ АДМИНА ---
            function setupAdminConstructor() {
                // Мы переместили создание кнопки '📦 Управление Товарами' в конструктор AdminStockManager,
                // чтобы она была гарантированно создана, если isAdmin = true.

                if (!isAdmin) {
                    // Если не админ, скрываем все кнопки админки
                    document.getElementById('edit-config-btn').style.display = 'none';
                    // Управление видимостью кнопки Управления Товарами теперь в AdminStockManager.setupUI
                    return;
                }

                // --- ИСПРАВЛЕНИЕ: Гарантируем видимость кнопок админ-панели ---
                const editBtn = document.getElementById('edit-config-btn');
                const stockBtn = document.getElementById('stock-manager-btn'); // Добавлено получение второй кнопки

                if (editBtn) {
                    editBtn.style.display = 'block';
                }
                // Кнопка stockBtn уже должна быть обработана в AdminStockManager.setupUI(), но для гарантии:
                if (stockBtn) {
                    stockBtn.style.display = 'block';
                }
                // ------------------------------------------------------------------

                let mainEditor, scratchpadEditor;
                const LS_VERSIONS_KEY = 'configVersions';
                const LS_SCRATCHPAD_KEY = 'scratchpadContent';
                // --- Элементы основного редактора ---
                // const editBtn = document.getElementById('edit-config-btn'); // уже определён
                const modal = document.getElementById('admin-config-modal');
                const mainTextarea = document.getElementById('config-textarea');
                const saveForTestBtn = document.getElementById('save-config-btn');
                const copyBtn = document.getElementById('copy-config-btn');
                const closeBtn = document.getElementById('close-config-btn');
                const undoBtn = document.getElementById('undo-btn');
                const redoBtn = document.getElementById('redo-btn');
                const versionsDropdown = document.getElementById('versions-dropdown');
                const loadVersionBtn = document.getElementById('load-version-btn');
                const saveAsBtn = document.getElementById('save-as-btn');
                const deleteVersionBtn = document.getElementById('delete-version-btn');
                const formatCodeBtn = document.getElementById('format-code-btn');

                // --- Элементы Блокнота ---
                const openScratchpadBtn = document.getElementById('open-scratchpad-btn');
                const scratchpadWindow = document.getElementById('scratchpad-window');
                const scratchpadHeader = document.getElementById('scratchpad-header');
                const scratchpadCloseBtn = document.getElementById('scratchpad-close-btn');
                const scratchpadTextarea = document.getElementById('scratchpad-textarea');
                const sendToScratchpadBtn = document.getElementById('send-to-scratchpad-btn');
                const getFromScratchpadBtn = document.getElementById('get-from-scratchpad-btn');

                // --- Функции для работы с версиями ---
                function getSavedVersions() { return JSON.parse(localStorage.getItem(LS_VERSIONS_KEY) || '{}'); }
                function saveVersions(versions) { localStorage.setItem(LS_VERSIONS_KEY, JSON.stringify(versions)); }
                function populateVersionsDropdown() {
                    const versions = getSavedVersions();
                    versionsDropdown.innerHTML = '<option value="">-- Выберите версию --</option>';
                    Object.keys(versions).sort((a, b) => b - a).forEach(id => {
                        const option = document.createElement('option');
                        option.value = id;
                        option.textContent = `${versions[id].name} (${new Date(parseInt(id)).toLocaleString()})`;
                        option.title = versions[id].comments;
                        versionsDropdown.appendChild(option);
                    });
                }

                // --- Инициализация редакторов ---
                const editorOptions = {
                    mode: { name: "javascript", json: true },
                    theme: "material-darker",
                    lineNumbers: true,
                    autoCloseBrackets: true,
                    lint: true,
                    foldGutter: true,
                    gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter", "CodeMirror-lint-markers"]
                };
                // --- НОВАЯ ФУНКЦИЯ ДЛЯ УМНОЙ ПОДСВЕТКИ ---
                function highlightSpecificValues(editor) {
                    // Очищаем предыдущие маркеры, чтобы избежать дублирования
                    editor.getAllMarks().forEach(mark => mark.clear());
                    // Ключи, значения которых мы хотим подсветить
                    const keysToHighlight = ['"tooltip"', '"text"', '"roomName"', '"name"', '"id"']; // Добавлен "id"
                    // Создаем регулярное выражение для поиска строк вида "ключ": "значение"
                    const regexString = `(${keysToHighlight.join('|')}):\\s*(".*?")`;
                    const regex = new RegExp(regexString, 'g');

                    // Проходим по каждой строке редактора
                    editor.eachLine(lineHandle => {
                        const lineText = lineHandle.text;
                        let match;
                        // Ищем все совпадения в строке
                        while ((match = regex.exec(lineText)) !== null) {
                            const valuePart = match[2]; // Это захваченная группа со значением ("...")
                            const valueStartIndex = match[0].lastIndexOf(valuePart);

                            // Вычисляем начальную и конечную позицию значения для подсветки
                            const from = { line: editor.getLineNumber(lineHandle), ch: match.index + valueStartIndex };
                            const to = { line: editor.getLineNumber(lineHandle), ch: from.ch + valuePart.length };

                            // Применяем CSS-класс к найденному фрагменту
                            editor.markText(from, to, { className: 'cm-custom-blue' });
                        }
                    });
                }

                // --- Логика основного редактора ---

                editBtn.addEventListener('click', () => {
                    modal.style.display = 'flex';

                    // --- ИЗМЕНЕНИЕ #2: Всегда загружать актуальный код в редактор ---
                    // Получаем самую свежую версию из localStorage или используем код по умолчанию.
                    const currentConfigInStorage = localStorage.getItem('customConfig');
                    const editorContent = currentConfigInStorage ? currentConfigInStorage : defaultConfigString;

                    if (!mainEditor) {
                        mainEditor = CodeMirror.fromTextArea(mainTextarea, editorOptions);

                        mainEditor.on('change', function (cm) {
                            if (cm.state.highlightTimeout) clearTimeout(cm.state.highlightTimeout);
                            cm.state.highlightTimeout = setTimeout(() => highlightSpecificValues(cm), 300);
                        });
                    }

                    // Устанавливаем актуальное содержимое в редактор
                    mainEditor.setValue(editorContent);
                    populateVersionsDropdown();
                    setTimeout(() => {
                        mainEditor.refresh();
                        highlightSpecificValues(mainEditor);
                    }, 1);
                });

                closeBtn.onclick = () => { modal.style.display = 'none'; };
                saveForTestBtn.onclick = () => {
                    try {
                        const codeToTest = mainEditor.getValue();
                        // Проверка синтаксиса
                        new Function('generateSmartCatalog', 'return ' + codeToTest)(generateSmartCatalog);

                        localStorage.setItem('customConfig', codeToTest);
                        // Сохраняем состояние наличия, чтобы оно не сбрасывалось при перезагрузке
                        const currentStockStatus = localStorage.getItem('stockStatus') || '{}';

                        // Используем пользовательское модальное окно вместо alert
                        if (window.confirm('Конфигурация временно сохранена! Страница будет перезагружена.')) {
                            // Принудительно очищаем и восстанавливаем stockStatus, чтобы он не потерялся
                            localStorage.removeItem('stockStatus');
                            localStorage.setItem('stockStatus', currentStockStatus);
                            window.location.reload();
                        }

                    } catch (e) {
                        console.error("Ошибка синтаксиса в конфигурации:", e);
                        // Используем пользовательское модальное окно вместо alert
                        window.alert('ОШИБКА СИНТАКСИСА! \n\nНе удалось сохранить конфигурацию. Проверьте консоль (F12) для получения подробной информации об ошибке.');
                    }
                };
                copyBtn.onclick = () => navigator.clipboard.writeText(mainEditor.getValue()).then(() => alert('Код скопирован.'));
                undoBtn.onclick = () => mainEditor.undo();
                redoBtn.onclick = () => mainEditor.redo();
                saveAsBtn.onclick = () => {
                    const name = prompt("Название версии:", "Новая конфигурация");
                    if (!name) return;
                    const comments = prompt("Комментарий (необязательно):");
                    const versions = getSavedVersions();
                    const newId = Date.now();
                    versions[newId] = { name, comments: comments || "", code: mainEditor.getValue() };
                    saveVersions(versions);
                    populateVersionsDropdown();
                    versionsDropdown.value = newId;
                };
                loadVersionBtn.onclick = () => {
                    const id = versionsDropdown.value;
                    if (!id) return;
                    const versions = getSavedVersions();
                    if (versions[id]) {
                        mainEditor.setValue(versions[id].code);
                        highlightSpecificValues(mainEditor);
                    }
                };
                deleteVersionBtn.onclick = () => {
                    const id = versionsDropdown.value;
                    if (!id) return;
                    const versions = getSavedVersions();
                    if (versions[id] && confirm(`Удалить версию "${versions[id].name}"?`)) {
                        delete versions[id];
                        saveVersions(versions);
                        populateVersionsDropdown();
                    }
                };
                formatCodeBtn.onclick = () => {
                    if (typeof js_beautify === 'undefined') {
                        // Используем пользовательское модальное окно вместо alert
                        window.alert('Библиотека для форматирования не загружена.');
                        return;
                    }
                    const currentCode = mainEditor.getValue();
                    const formattedCode = js_beautify(currentCode, {
                        indent_size: 2,
                        space_in_empty_paren: true,
                        end_with_newline: true
                    });
                    mainEditor.setValue(formattedCode);
                };

                // --- Логика Блокнота ---
                openScratchpadBtn.onclick = () => {
                    scratchpadWindow.style.display = 'flex';
                    if (!scratchpadEditor) {
                        scratchpadEditor = CodeMirror.fromTextArea(scratchpadTextarea, editorOptions);
                        scratchpadEditor.setValue(localStorage.getItem(LS_SCRATCHPAD_KEY) || "// Это ваш блокнот для фрагментов кода");
                        scratchpadEditor.on("change", () => {
                            localStorage.setItem(LS_SCRATCHPAD_KEY, scratchpadEditor.getValue());
                        });
                    }
                    setTimeout(() => scratchpadEditor.refresh(), 1);
                };

                scratchpadCloseBtn.onclick = () => { scratchpadWindow.style.display = 'none'; };
                sendToScratchpadBtn.onclick = () => {
                    if (!scratchpadEditor) openScratchpadBtn.click();
                    const selection = mainEditor.getSelection();
                    if (selection) scratchpadEditor.setValue(selection);
                };

                getFromScratchpadBtn.onclick = () => {
                    if (scratchpadEditor) mainEditor.replaceSelection(scratchpadEditor.getValue());
                };

                // Логика перетаскивания окна Блокнота
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                scratchpadHeader.onmousedown = (e) => {
                    e.preventDefault();
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = () => { document.onmouseup = null; document.onmousemove = null; };
                    document.onmousemove = (e) => {
                        e.preventDefault();
                        pos1 = pos3 - e.clientX;
                        pos2 = pos4 - e.clientY;
                        pos3 = e.clientX;
                        pos4 = e.clientY;
                        scratchpadWindow.style.top = (scratchpadWindow.offsetTop - pos2) + "px";
                        scratchpadWindow.style.left = (scratchpadWindow.offsetLeft - pos1) + "px";
                    };
                };
            }

            // --- ЗАПУСК ПРИЛОЖЕНИЯ ---
            function setupConferenceButton() {
                const confConfig = CONFIG.videoConference;
                const wrapper = document.getElementById('conferenceBtnWrapper');
                if (confConfig && confConfig.enabled) {
                    wrapper.style.display = 'flex';
                    conferenceBtn.title = confConfig.tooltip || 'Видеоконференция';
                    wrapper.querySelector('.button-label').textContent = confConfig.buttonText || 'эфир';
                    conferenceBtn.onclick = openConferenceModal;
                } else {
                    // Управляется через setupBottomMenuButtons
                    // wrapper.style.display = 'none';
                }
            }

            // --- НОВЫЕ ФУНКЦИИ ДЛЯ МАГАЗИНА (ИСПРАВЛЕННЫЕ) ---
            window.orderOneClick = function (productName, channel) {
                const message = encodeURIComponent(`Здравствуйте! Хочу заказать через ${channel === 'telegram' ? 'Telegram' : 'WhatsApp'}: ` + productName);

                if (channel === 'telegram') {
                    window.open('https://t.me/Vasilisaznamenskaya?text=' + message, '_blank');
                } else if (channel === 'whatsapp') {
                    window.open('https://wa.me/79213047892?text=' + message, '_blank');
                }
                // Instagram не используется для one-click заказа
            };

            // --- НОВАЯ ЛОГИКА: ССЫЛКИ ДЛЯ КНОПОК НИЖНЕГО МЕНЮ (ЗАДАЧА 1) ---
            telegramBtn.onclick = () => {
                window.open('https://t.me/Vasilisaznamenskaya', '_blank');
            };
            whatsappBtn.onclick = () => {
                window.open('https://wa.me/79213047892', '_blank');
            };
            instagramBtn.onclick = () => {
                // Замените на фактическую ссылку на Instagram
                window.open('https://www.instagram.com/vasilisa.luneville?igsh=a3JiM2p5bXR6ZnVv', '_blank');
            };
            // ---------------------------------------------------------------

            // --- ОБНОВЛЕННАЯ ФУНКЦИЯ ПОКАЗА ДЕТАЛЕЙ (С ПРЕЗЕНТАЦИЕЙ) ---
            window.showProductDetails = function (title, price, description, imageUrl, videoUrl, mediaJson, presentationJson) {
                // 1. Раскодируем описание обратно в текст
                let decodedDesc = decodeURIComponent(description);

                // 2. Превращаем переносы строк в HTML теги <br>, чтобы текст не слипался
                decodedDesc = decodedDesc.replace(/\n/g, '<br>');

                const modalHeader = document.querySelector('#mediaModal .modal-header');
                const modalFooter = document.querySelector('#mediaModal .modal-footer');

                let content = `
            <div style="text-align: center;">
                <img src="${imageUrl || 'https://via.placeholder.com/300x200'}" style="max-width: 100%; max-height: 300px; object-fit: contain; border-radius: 8px; margin-bottom: 15px;">
                <h2 style="color: #333; margin-bottom: 10px;">${title}</h2>
                <h3 style="color: #E91E63; margin-bottom: 15px;">${price}</h3>
                <p style="text-align: left; line-height: 1.5; margin-bottom: 20px;">${decodedDesc}</p>
        `;

                // Если есть отдельное главное видео, добавляем его
                if (videoUrl) {
                    content += `
                <div style="margin-bottom: 20px;">
                    <strong>Видео обзор:</strong>
                    <iframe src="${videoUrl}" style="width: 100%; height: 200px; border: none; border-radius: 8px; margin-top: 10px;"></iframe>
                </div>
            `;
                }

                // --- НОВАЯ ЛОГИКА: ПРЕЗЕНТАЦИЯ ---
                if (presentationJson && presentationJson !== 'undefined' && presentationJson !== '') {
                    try {
                        const slides = JSON.parse(decodeURIComponent(presentationJson));
                        if (Array.isArray(slides) && slides.length > 0) {
                            content += `<button class="presentation-mode-btn" onclick="window.initPresentation(decodeURIComponent('${presentationJson}'))">▶ Смотреть Презентацию Курса</button>`;
                        }
                    } catch (e) {
                        console.error('Ошибка при разборе презентации:', e);
                    }
                }

                // --- НОВАЯ ЛОГИКА: ОБРАБОТКА МАССИВА МЕДИА (ФОТО И ВИДЕО) ---
                if (mediaJson && mediaJson !== 'undefined') {
                    try {
                        const mediaArray = JSON.parse(decodeURIComponent(mediaJson));
                        if (Array.isArray(mediaArray) && mediaArray.length > 0) {
                            content += `<div style="text-align: left; margin-top: 15px;"><strong>Галерея:</strong></div>`;
                            content += `<div class="product-gallery-container">`;

                            mediaArray.forEach(item => {
                                if (item.type === 'photo') {
                                    content += `<img src="${item.url}" class="product-gallery-item" alt="Фото">`;
                                } else if (item.type === 'video') {
                                    // Проверка на YouTube/обычное видео
                                    if (item.url.includes('youtu.be') || item.url.includes('youtube.com')) {
                                        const videoId = item.url.split('v=')[1] || item.url.split('/').pop().split('?')[0];
                                        const embedUrl = `https://www.youtube.com/embed/${videoId}`;
                                        content += `<iframe src="${embedUrl}" class="product-gallery-video" frameborder="0" allowfullscreen></iframe>`;
                                    } else {
                                        content += `<video src="${item.url}" class="product-gallery-video" controls playsinline></video>`;
                                    }
                                }
                            });

                            content += `</div>`;
                        }
                    } catch (e) {
                        console.error('Ошибка при разборе mediaJson:', e);
                    }
                }
                // -------------------------------------------------------------

                // --- Добавление кнопок Заказа в модальное окно (используя CONFIG) ---
                const productCardButtons = CONFIG.productCardButtons || {};

                if (productCardButtons.orderTelegram) {
                    content += `<button onclick="window.orderOneClick('${title.replace(/'/g, "\\'")}', 'telegram')" style="background: #0088cc; color: white; border: none; padding: 12px 24px; border-radius: 5px; font-size: 1.1em; cursor: pointer; width: 100%; margin-top: 10px;">Заказать через Telegram</button>`;
                }

                if (productCardButtons.orderWhatsapp) {
                    content += `<button onclick="window.orderOneClick('${title.replace(/'/g, "\\'")}', 'whatsapp')" style="background: #25D366; color: white; border: none; padding: 12px 24px; border-radius: 5px; font-size: 1.1em; cursor: pointer; width: 100%; margin-top: 10px;">Заказать через WhatsApp</button>`;
                }

                content += `</div>`;

                openMediaModal({
                    type: 'text',
                    headerText: 'Детали товара',
                    htmlContent: content
                });
            };

            // --- НОВАЯ ФУНКЦИЯ ИНИЦИАЛИЗАЦИИ ПРОСМОТРА ПРЕЗЕНТАЦИИ ---
            window.initPresentation = function (jsonSlides) {
                const slides = JSON.parse(jsonSlides);
                let currentSlide = 0;

                const renderSlide = (index) => {
                    const slide = slides[index];
                    const modalText = document.getElementById('modalText');

                    let mediaHtml = '';
                    if (slide.media) {
                        if (slide.mediaType === 'video' || slide.media.endsWith('.mp4') || slide.media.endsWith('.MOV')) {
                            mediaHtml = `<video src="${slide.media}" controls class="slide-media"></video>`;
                        } else {
                            mediaHtml = `<img src="${slide.media}" class="slide-media" alt="Слайд медиа">`;
                        }
                    }

                    const html = `
            <div class="presentation-container">
                <div class="slide-card">
                    <div class="slide-header">
                        <span class="slide-type">${slide.type}</span>
                        <span class="slide-number">#${slide.slideNumber}</span>
                    </div>
                    <div class="slide-title">${slide.header}</div>
                    ${mediaHtml}
                    <div class="slide-text">${slide.slideText}</div>
                    
                    </div>
                
                <div class="presentation-controls">
                    <button class="presentation-nav-btn prev" ${index === 0 ? 'disabled' : ''} onclick="window.changeSlide(-1)">❮ Назад</button>
                    <button class="presentation-nav-btn next" ${index === slides.length - 1 ? 'disabled' : ''} onclick="window.changeSlide(1)">Вперед ❯</button>
                </div>
                <button onclick="window.closePresentation()" style="margin-top:10px; background:none; border:none; color:#666; cursor:pointer;">Вернуться к товару</button>
            </div>
            `;

                    modalText.innerHTML = html;
                    // Прокрутка вверх при смене слайда
                    modalText.scrollTop = 0;
                };

                // Сохраняем состояние в глобальные переменные (простой способ для встроенных функций onclick)
                window.currentPresentationSlides = slides;
                window.currentPresentationIndex = 0;

                window.changeSlide = function (direction) {
                    const newIndex = window.currentPresentationIndex + direction;
                    if (newIndex >= 0 && newIndex < window.currentPresentationSlides.length) {
                        window.currentPresentationIndex = newIndex;
                        renderSlide(newIndex);
                    }
                };

                // Функция возврата (просто перезагружаем детали товара, сохраняя контекст - пока просто закрываем режим презентации)
                // Для простоты реализации "Add only" без сложного state management, мы можем просто перезагрузить 
                // контент модального окна через showProductDetails, но нам нужно где-то хранить исходные данные.
                // Самый простой способ - просто закрыть презентацию и пользователь снова откроет товар.
                // Но лучше сделать кнопку "Закрыть презентацию", которая вернет HTML товара.
                // Т.к. мы заменяем innerHTML, проще всего просто перезапросить showProductDetails.
                // Но у нас нет всех данных под рукой в этой функции.
                // Поэтому сделаем кнопку "Закрыть", которая просто закроет модальное окно.
                window.closePresentation = function () {
                    // Закрываем модальное окно полностью
                    document.querySelector('.modal-close').click();
                };

                renderSlide(0);
            };

            setupCover();
            setupBookPages();
            setupBottomMenuButtons(); // Вызываем новую функцию для управления видимостью
            setupConferenceButton();
            updateAdminPanel();
            setupAdminConstructor(); // Запускаем конструктор, если это админ

            // ДОБАВЛЯЕМ НОВЫЙ ЭКЗЕМПЛЯР МЕНЕДЖЕРА ЗАПАСОВ
            window.AdminStockManagerInstance = new AdminStockManager(CONFIG);

            if (isFeedMode) {
                if (prevBtn) prevBtn.parentElement.style.display = 'none';
                if (nextBtn) nextBtn.parentElement.style.display = 'none';
                if (pageIndicator) pageIndicator.style.display = 'none';
            }

            // =============================================================================
            // --- ЛОГИКА ОТКЛЮЧЕНИЯ ОБЛОЖКИ (НОВАЯ ФУНКЦИЯ) ---
            // =============================================================================
            if (CONFIG.showCover === false) {
                // Меняем состояние флага
                isCoverActive = false;

                // Скрываем обложку
                if (coverView) {
                    coverView.style.display = 'none';
                    // Важно для режима ленты, чтобы она не занимала место
                    coverView.style.setProperty('display', 'none', 'important');
                }

                // Показываем книгу (если не режим ленты, в ленте она и так видна)
                if (!isFeedMode) {
                    if (bookView) bookView.style.display = 'flex';
                    // Активируем первую страницу
                    showPage(1);
                } else {
                    // В режиме ленты просто убеждаемся, что мы не на обложке визуально
                    // и раскрываем первую страницу, если это требуется по логике
                    const firstPageDetails = document.querySelector('.page[data-page-number="1"] details');
                    // Если хотим, чтобы первая страница была открыта сразу в режиме без обложки
                    if (firstPageDetails) {
                        firstPageDetails.open = true;
                    }
                }

                // Обновляем состояние кнопок навигации, так как обложка скрыта
                updateButtonsAndIndicator();
            }

        });
    </script>
</body>

</html>
